---
title: "IXN D — Exploratory Data Analysis"
author: "ANONYMIZED"
date: "2023-09-08"
output:
  html_document:
    theme: flatly
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '4'
always_allow_html: yes
font-family: DejaVu Sans
mainfont: DejaVu Sans
---

NOTE! THE CONTENT OF THIS NOTEBOOK [UP UNTIL WIP] is included in CHI-submission supplementals.  Further analysis should pick up and extend WIP section. 

This notebook includes *exploratory data analysis* (primarily through visualization) for data collected for the IXN-D project. These analyses were conducted by [TODO-X-ANONYMIZED] who can be reached at [TODO-X-ANONYMIZED].

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#UTILITIES
library(Hmisc) # %nin% operator
library(tidyverse) #all the things
library(summarytools) #data quality
library(jtools) #Social Science regression utilities
library(lubridate) #dealing with dates

#VIZ
library(kableExtra) #printing tables
library(ggformula) #regression syntax viz
# library(vcd) #mosaic plots
# library(vcdExtra) #mosaic plot helpers
library(ggstatsplot) #dummies

#MODELLING
library(easystats) #modelling helpers
library(see)
library(sjPlot)
library(lme4)
library(lmerTest) #for CIs in glmer

options(readr.show_col_types = FALSE) #don't show coltypes on read_csv

```

Data are imported for analysis from two sources:

1.  **coded utterances ---** CSV file `CLEAN_coded_utterances.csv` constitutes output of content analysis coding process, which transforms linguistic output of (experimental) task transcripts into discretized units of meaning, each associated with (no more than 2) detail-code and a corresponding topic-code, indicating the topic & (detail) subject to which the utterance referred. Importantly, this sheet *also* contains a (manual) identification of *what representations* the participant was using *while making an utterance*. These data were entered by the analyst during the content analysis process.

2.  **telemetry representations** --- CSV file `arf_CLEAN_telemetry_representations.csv` constitutes output of telemetry wrangling scripts, which transform raw log-telemetry data from the (experimental) analysis tasks into a flat file indicating what representations (including code and data visualizations) were generated by participants at what times

Through the data import process we cast a number of dataframe variables as FACTORS to be used during analysis, and the construct the following dataframes:

1.  **Raw data** [for reference, troubleshooting]
    1.  `df_raw_utterances` raw utterance data from `coded_utterances.csv`

    2.  `df_raw_telemetry` raw (telemetry) representation data from `telemetry_representations.csv`
2.  **Wrangled data** [for analysis]
    1.  `df_coded` utterance data (from `df_raw_utterances`) . Each row corresponds to one unique [utterance+detail code] pair. In most cases, utterances are unique. In a limited number of cases where utterances are *dual-coded* (the utterance contained more than one unit of meaning but could not be further discretized into smaller utterances while maintaining readability),the utterance then appears on two rows, once for each associated detail-code.

    2.  `df_codedrep` utterance + (manual) representation data (from `df_raw_utterances`). This dataframe takes the `df_coded` df and pivots it to a long format where each row/observation refers to one unique [utterance+representation] combination. Many utterances were generated via reference to more than one representation (again, these representations were manually added by the data analyst doing content analysis coding, who made note of what representations the participant scrolled to, interacted with, and/or made reference to with mouse gestures).

    3.  `df_telemetry` log-telemetry data (from `df_raw_telemetry`). Each row indicates a unique representation (code output, table, or visualization) generated during the (experimental) analysis tasks, and captured by the logging utility attached to the Jupyter notebook. Each row represents a unique representation, or *version* of the representation (i.e. if an interaction technique, or additional encoding is added to an existing representation in a code cell, this is tracked as a new representation.)

```{r IMPORT, message=FALSE, warning=FALSE}

#IMPORT (wrangled) data 
df_raw_utterances <- read_csv("data/CLEAN_coded_utterances.csv") 
df_raw_telemetry <- read_csv("data/arf_CLEAN_telemetry_representations.csv") 

##PRIMARY UTTERANCE DF
#NOT unique utterances, 1 obs for each utterance+detail-code
df_coded <- df_raw_utterances %>% 
  #rename and factorize cols
  mutate(
    #UNIQUE IDS
    sid = factor(SID), #unique ID for utterance+detail-code
    pid = factor(PID, levels = c( #define level order so happiness first
      #HAPPINESS-FIRST    
      "bjs827ee1u", "3r2sh20ei", "4728sjuiz","7ACC0B75","92ghd48xe","iurmer289", "s294hoei",
      #SPACE-FIRST    
      "j2719eertu2","lkin27js09b","li832lin23","7382kwtue","E1D39056","8v892iige")),   
    #create unique ID for utterances
    uid = factor(as.numeric(factor(paste(pid,factor(Utterance))))), #construct a unique ID for utterances
    #recode lower case and order based on true task order
    TASK = factor(recode(Condition, "Static"="static", "Interactive"="ixn" )),
    TASK = factor(TASK, levels = c("static", "ixn")), #reorder factor levels
    #rename Notebook as DATASET
    DATASET = factor(recode(Notebook, "Happiness"="happiness", "Space"="space")),
    #create temp dataset order var
    data_order = factor(paste(TASK,"_",DATASET)), #create an order var 
    data_order = recode(data_order, "ixn _ happiness"="space-first",
                                    "ixn _ space"="happiness-first",
                                    "static _ happiness"="happiness-first",
                                    "static _ space"="space-first"),
    utterance = Utterance,
    reps_group = factor(Final_Group),
    reps_all = factor(`All representations`),
    #rename flags
    flag_story = `Flag_Storytelling`,
    flag_correction = `Flag_Correction`,
    flag_simultaneous = `Flag_Simultaneous_Characterization`,
    #recode and order TOP LEVEL CODES 
    code_topic = factor(Highlevel),
    code_topic = recode(code_topic, "ANALYSIS PROCESS" = "PROCESS"),
    code_topic = factor(code_topic, levels = c("PROCESS","DATASET","VARIABLE","RELATIONSHIP")),
    code_datatype = factor(`Data Type`),
    code_detail = factor(`Utterance Type`),
    #collapse two detail codes due to sparsity (less than 3 obs)
    #collapse dist.var -> dist shape 
    #collapse rel faceted -> rel strength
    code_detail = recode(code_detail, 
                         "distribution variance (sd, var)" = "distribution shape [shape, skew, kurtosis]",
                         "relationship faceted distribution characterization" = "relationship strength and/or direction"  
                         ),
    #reorder factor for good graphs
    code_detail = factor(code_detail, levels = c(
    "distribution outlier (variable)",             
    "distribution range [min, max]",               
    "distribution shape [shape, skew, kurtosis]",  
    "data size",                                   
    "variable metadata",    
    "data provenance",                             
    "data orientation",                            
    "missing data",                                
    "relationship range constriction",             
    "relationship form (linearity/non-linearity)", 
    "relationship cluster(s)/subgroup/ unexpected",
    "relationship existence / non-existence",      
    "outlier (relationship)",                      
    "relationship strength and/or direction",      
    "plan of action",                              
    "representation comment")),                    
    timestamp = adj_timestamp,
    ixn = factor(interaction_used), #was interaction used?
    PNUM = factor(PNUM,levels = c("P6", "P9", "P10", "P2", "P4", "P12","P13", 
                                   "P5", "P7", "P8", "P3", "P1","P11")),
    
    ) %>% 
  dplyr::select(sid,pid,PNUM,uid,TASK,DATASET,timestamp,ixn,code_topic,code_detail,code_datatype,
         flag_story, flag_correction, flag_simultaneous, utterance, reps_group, reps_all, data_order) %>% 
  arrange(data_order)

#REPLACE NA in logicals to FALSE  
df_coded$flag_story[is.na(df_coded$flag_story)] <- FALSE
df_coded$flag_correction[is.na(df_coded$flag_correction)] <- FALSE
df_coded$flag_simultaneous[is.na(df_coded$flag_simultaneous)] <- FALSE



##NOW WRANGLE TIME INFO
# #CALCULATE RELATIVE TASK TIMES
df_coded <- df_coded %>% mutate(
  time = hms::as_hms(timestamp)
) %>% group_by(pid, TASK) %>%
  # dplyr::summarise( .groups="keep",
  mutate(
    task_start = hms::as_hms(min(time)),
    task_end = hms::as_hms(max(time)),
    task_mins = round(difftime(task_end,task_start, units="mins"),1),
    task_second = task_end - task_start,
    relative_time_s = timestamp-task_start,
    relative_time = as.double(relative_time_s)
  ) %>% ungroup() 
# %>%  dplyr::select(pid,PNUM, code_topic,code_detail, TASK,DATASET,timestamp,task_start,relative_time_s,relative_time)


##JOINED REPRESENATIONS DURING UTTERANCES DF
#START with REPRESENTATIONS associated with UTTERANCES
#ROW is unique utterance + rep combination
#many-many relationship between utterances and representations
df_codedrep <- df_coded %>% 
  dplyr::select(-data_order,-utterance, -flag_story, -flag_correction) %>% 
  mutate(
    #replace "data_dictionary" with dictionary
    #rename "Multi-view Chart"          
    reps_group  = factor(str_replace(reps_group, "data_dictionary", "dictionary")),
    reps_group  = factor(str_replace(reps_group, "Multi-view Chart", "multiviewchart")),                         
    reps_multi  = str_detect(reps_group,"_")) %>%  #flag multiple-representations 
  separate_longer_delim(reps_group, delim = "_") %>% #pivot longer based _ in reps_group
  mutate (
    REP = factor(reps_group),
    #create simplified condensed detail reps
    rep_simple = recode(REP,
                       
          "multiviewchart" = "multi-view chart",  
          "heatmap" = "heatmap",         
          "pairplot" = "pairplot",        
          "stripplot" = "stripplot",       
          "lineplot" = "lineplot",        
          "scatterplot" = "scatterplot",     
          "barplot" = "barplot",         
          "double-profiler" = "profile", 
          "profile" = "profile", 
          "hist" = "histogram",            
          "python" = "CODE",           
          "dictionary" = "TABLE",   
          "describe" = "TABLE",
          "dataframe" = "TABLE",        
          "info" = "TABLE",             
          "columns" = "TABLE",          
          "none"  ="NONE"     
          
          )) %>% 
  dplyr::select(-reps_group) %>%  #drop reps_group column since now separated
  mutate(
    rep_type = recode(REP, 
                      "hist" = "CHART",                      
                      "profile" = "CHART",                   
                      "scatterplot" = "CHART",               
                      "barplot" = "CHART",                   
                      "stripplot" = "CHART",                 
                      "lineplot" = "CHART",                     
                      "heatmap" = "CHART",                    
                      "pairplot" = "CHART",                   
                      "multiviewchart" = "CHART",           
                      "double-profiler" = "CHART",           
                      "profile" = "CHART", 
                      "python" = "CODE",                    
                      "dictionary" = "CODE",   
                      "describe" = "CODE",
                      "dataframe" = "CODE",         
                      "info" = "CODE",                      
                      "columns" = "CODE",                  
                      "none"  ="NONE"     
  ))

##PRIMARY REPRESENATION DF
#ROW ==? 
df_telemetry <- df_raw_telemetry %>% 
  mutate(
  
    #PARTICIPANT DATA
    pid = factor(pID, levels = c( #define level order so happiness first
      #HAPPINESS-FIRST    
      "bjs827ee1u", "3r2sh20ei", "4728sjuiz","7ACC0B75","92ghd48xe","iurmer289", "s294hoei",
      #SPACE-FIRST    
      "j2719eertu2","lkin27js09b","li832lin23","7382kwtue","E1D39056","8v892iige")),   
    PNUM = factor(PNUM,levels = c("P6", "P9", "P10", "P2", "P4", "P12","P13", 
                                   "P5", "P7", "P8", "P3", "P1","P11")),
    

    
    TASK = factor(TASK, levels = c("static", "ixn")), #reorder factor levels
    DATASET = factor(session, levels = c("happiness","space")),
    #create temp dataset order var
    data_order = factor(paste(TASK,"_",DATASET)), #create an order var 
    data_order = recode(data_order, "ixn _ happiness"="space-first",
                                    "ixn _ space"="happiness-first",
                                    "static _ happiness"="happiness-first",
                                    "static _ space"="space-first"),
    timestamp = timestamp,
    time_elapsed = time_elapsed,
    technique = factor(`Interaction_Techniques`),
    IXN = (technique!="none"),
                         
    code = cell_content,
    REP = factor(merged_output_type),
    REP = factor(str_replace(REP, "Multi-view Chart", "multiviewchart"))) %>% 
  filter( #EXCLUDE SOME REPS
    #none and other are python code not of the tabular forms we look for
    REP %nin% c("none","error","markdown","other")
  ) %>% mutate(
    REP = recode_factor(REP, 
               "double-profiler" = "profile",
               "countplot" = "barplot"),
    REP = factor(REP), #reset factor levels
    rep_type = recode(REP,
                      # "dictionary" = "TABLE",   
                      "describe" = "TABLE",
                      "dataframe" = "TABLE",         
                      "info" = "TABLE",                      
                      "columns" = "TABLE",
                      "hist" = "CHART",                      
                      "profile" = "CHART",                   
                      "double-profiler" = "CHART",           
                      "countplot" = "CHART",
                      "barplot" = "CHART",                   
                      "scatterplot" = "CHART",               
                      "lineplot" = "CHART",                     
                      "stripplot" = "CHART",                 
                      "pairplot" = "CHART",                   
                      "heatmap" = "CHART",                    
                      "multiviewchart" = "CHART"
                      )) %>%      
  dplyr::select(pid,PNUM,TASK,DATASET,data_order,timestamp,time_elapsed,technique,IXN,REP,rep_type,cell_content)

```

The following variables, some common across dataframes, are especially important to the subsequent analyses:

1.  `PID` is a (unique) random identifier for participant
2.  `PNUM` is the corresponding 'participant number' (e.g. P1, P2, etc) for each `PID` as used in the paper
3.  `TASK` refers to the experimental task (within-subjects; repeated measures) either `static` or `ixn` (interactive)
4.  `DATASET` refers to the dataset attached to the corresponding `TASK`, either `happiness` (had a numeric-continuous outcome variable) or `space` (had a nomial-categorical outcome variable)
5.  `data_order` indicates the dataset counterbalancing order for the corresponding participant, either `space-first` or `happiness-first`. Most graphs are *sorted* by `data_order`
6.  `code_topic` is the outcome variable indicating the highest level code applied during content analysis
7.  `code_detail` is the outcome variable indicating the lowest-level (detail) code applied during content analysis
8.  `ixn` is a boolean flag (for utterance dfs only) indicating whether the participant was *actively engaging with an interactive visualization* while making the utterance. (i.e. inspecting/reading an interactive graph without using the interaction feature is coded as `FALSE`)
9.  `relative_time` indicates the time (in seconds) after the start of the task at which the utterance occurs
10. `rep_simple` is an outcome variable indicating what kind of representation what was used while the utterance was made (detail of visualization type + one category for code output + one category for code output that yields a table, such as df.describe(), df.info(), etc.)
11. `rep_type` is an outcome variable indicating the high-level category for what kind of representation was used while the utterance was made: `CHART`, `CODE` (including tables) or `NONE`
12. `REP` is used in the `df_telemetry` df to refer to the detail kind of representation
13. `rep_type` is used in the `df_telemetry` df to refer to high level kind of representation, but does not include code cells *other* than those that generate tables. (Also does not contain NONE as a valid value because NONE refers to utterances made without reference to a representation, and the telemetry data contains only representations, not utterances)

# PROFILE DATA

## PROFILE UTTERANCE-CODE

There are `r nrow(df_coded)` rows in the `df_coded` dataset, where each row represents an utterance+coding (i.e. utterance + detail code). There are `r nlevels(df_coded$uid)` *unique* utterances. The difference indicates utterances that were *dual-coded* (i.e. two detail-level codes). No more than two codes were applied to a single utterance. For the purposes of analysis, dual-coded utterances will be treated as two utterances, as they have two distinct (but lexically insepeperable) units of meaning.

*The following profile reflects a dataframe where individual observations refer to unique utterance+detail_code*.

```{r utterance-profile, results="asis", warning=FALSE, message=FALSE}

df_coded%>% summarytools::dfSummary(
             plain.ascii  = FALSE,
             graph.magnif = 0.75,
             style        = "grid",
             tmp.img.dir  = "temp",
             missing.col = FALSE, 
             method = "render"
)

```

*[TODO-X-ANONYMIZED] has reviewed data profile for missing data and correct factorization.*

## PROFILE UTTERANCE-REPRESENTATION

There are `r nrow(df_codedrep)` rows in the `df_codedrep` dataset, where each row represents an utterance+representation (i.e. utterance + detail-level rep). There are `r nlevels(df_codedrep$uid)` *unique* utterances (*should match `df_coded` dataframe*). The difference indicates utterances that used *multiple representations* (i.e. two graphs, or a graph and a table).

*The following profile reflects a dataframe where individual observations refer to unique utterance+representation*.

```{r utterance-rep-profile, results="asis", warning=FALSE, message=FALSE}

df_codedrep%>% summarytools::dfSummary(
             plain.ascii  = FALSE,
             graph.magnif = 0.75,
             style        = "grid",
             tmp.img.dir  = "temp",
             missing.col = FALSE, 
             method = "render"
)

```

*[TODO-X-ANONYMIZED] has reviewed data profile for missing data and correct factorization.*

## PROFILE REPRESENTATIONS

There are `r nrow(df_telemetry)` rows in the `df_telemetry` dataset, where each row represents a unique representation generated by a participant during an analysis task, as captured by the logging utility.

There are `r nrow(df_telemetry)` *unique* representation-versions. The difference between this and the number of representations referenced in the`df_codedrep` is a result of the orientation and source of the data: `df_telemetry` may contain representations that are not used in the course of making an utterance, and `df_codedrep` may include representations that are referenced multiple times in the course of multiple utterances. There is no variable on which representations from `df_telemetry` and `df_codedrep` can joined.

*The following profile reflects a dataframe where individual observations refer to unique representation_versions.*

```{r REP-profile, results="asis", warning=FALSE, message=FALSE}

df_telemetry%>% summarytools::dfSummary(
             plain.ascii  = FALSE,
             graph.magnif = 0.75,
             style        = "grid",
             tmp.img.dir  = "temp",
             missing.col = FALSE, 
             method = "render"
)

```

*[TODO-X-ANONYMIZED] has reviewed data profile for missing data and correct factorization.*

# EXPLORE UTTERANCES

**Utterances** are the lowest-level discrete units of meaning transcribed from the EDA Task transcripts. Utterances are coded at two levels of analysis: (1) **topic-code** gives a *high level* topic of the participant's verbalization, (2) **detail-code** gives the *lower level* detail of the subject.

In the following subsections we explore the distribution of *number of utterances* based on TASK, DATASET, and PARTICIPANT, before describing the distribution of utterances *through the timecourse* of the TASK.

## [Number of] Utterances

FIRST we explore the distribution of utterances by Analysis Task, Dataset, Participant and Time, irrespective of what the utterance was about (topic, detail).

***RQ: How much did participants talk aloud during EDA? When did they talk aloud?***

***Answer:** Inspection of frequency tables and visualizations suggests that the most substantial determinant of how many utterances an individual made is individual participant-level differences, rather than structural differences imposed by the TASK or DATASET. This is not altogether unexpected given the fact that across both tasks (static/interactive) and datasets the structure of the experimental task was the same*

### by TASK

```{r results='asis'}

print("BY TASK")
freq(df_coded$TASK, 
     cumul      = FALSE,
     headings   = FALSE,
     report.nas = FALSE,
     plain.ascii = FALSE) 

```

### by TASK and DATASET

```{r results="asis", message=FALSE}

#COUNT BY TASK AND DATASET
ctable(x = df_coded$TASK, 
       y = df_coded$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>% 
  group_by(TASK,DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "Utterances by TASK and DATASET",
        subtitle = "More utterances in STATIC; more utterances in HAPPINESS",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")

```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT AND TASK
ctable(x = df_coded$PNUM, 
       y = df_coded$TASK, 
       prop = "r")  

#UTTERANCES by PARTICPANT facet TASK color DATASET
gf_bar( PNUM ~., fill = ~ DATASET, data = df_coded) %>% 
  gf_facet_grid(.~TASK) + 
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "DATASET"
  )

```

### through TIME

```{r}


#DOTPLOT—PARTICIPANT-facet-TASK-color-DATASET
ggplot(df_coded, aes(x=relative_time, y = PNUM, color = DATASET)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_coded$TASK) +
  # scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Participant Utterances over timecourse of Task",
    subtitle = "(does not appear to differ through time by task or dataset) ",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Dataset"
  ) 


#HISTOGRAMS BY TASK
ggplot(df_coded, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density..)) + 
  geom_density()+
  facet_grid(df_coded$TASK) +
  theme_minimal() + labs(
    title = "Participant Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
  ) + theme_minimal() + theme(legend.position = "blank")


```

## [TOPIC of] Utterances

NEXT we explore the distribution of utterances coded by high level TOPIC, across Analysis Task, Dataset, Participant and Time.

***RQ: What kinds of things did participants talk aloud during EDA? Did they progress through any 'topical phases' over the course of the task? Or are topics equally distributed across analysis time?***

***Answer:** Inspection of frequency tables and visualizations suggests that:*

1.  *Individual differences continue to play an important role*

2.  *There do not appear to be strong TASK/DATASET effects on topic that are consistent across participants.*

3.  *PROCESS and RELATIONSHIP topics are more evenly distributed across the timecourse of analysis, while DATASET AND VARIABLE topics are more tightly clustered near the beginning of the analysis. This pattern of distribution is sensical given what we know about EDA, and is consistent with the intuition that patterns of thought during EDA are likely more iterative and situational than we think (or model).*

### TOPICS

```{r}

freq(df_coded$code_topic, 
     cumul      = FALSE,
     headings   = TRUE,
     report.nas = FALSE,
     plain.ascii = FALSE) 

gf_bar(~code_topic, fill = ~code_topic, position="stack", data = df_coded) + 
  scale_fill_brewer(type="qual", palette = 3) 

df_summary <- df_coded %>% 
  group_by(code_topic) %>% 
  summarise(n = n()) %>%
  mutate(freq = n / sum(n),
         dumm =  factor("x"))

#TOPIC 
ggplot(df_summary, aes(y=freq, x = dumm, fill= fct_rev(code_topic))) + 
  geom_col() + 
  geom_text(aes(label=paste(round(freq*100,0),"%")), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs( title = "TOPIC OF UTTERANCES",
        subtitle = "",
        caption = "The most frequent topic of utterance was relationship (38%) \n with only 16% concerned with nature of variables",
        x= "TASK", y = "count", fill = "Topic") + theme_minimal() 


```

### by TASK

```{r results='asis', message=FALSE}

#COUNT BY TASK
ctable(x = df_coded$code_topic, 
       y = df_coded$TASK, 
       prop = "r")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>% 
  group_by(code_topic, TASK) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(code_topic))) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs( title = "TOPICS by TASK",
        subtitle = "Interactive task yielded fewer utterances than Static task",
        caption="Relative distribution of topics was similar across tasks",
        x= "TASK", y = "count", fill="Topic") + theme_minimal() 
# + theme(legend.position = "blank")
```

### by TASK and DATASET

```{r results="asis", message=FALSE}


#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>%
  group_by(code_topic, TASK,DATASET) %>%
  dplyr::summarise(
    c = n()
  )

#PAPER FIGURE HERE
#STACKED BAR BY TASK FACET DATASET
(p <- ggplot(df_summary, aes(x = TASK, y=c, fill= (code_topic))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  # scale_fill_manual(values=c(
  #   "#7FADCB", ##ACA2BA",
  #   "#A2D8D0", ##33A02C", #"#C2E2B7",
  #   "#B2DF8A", #AED8D2",
  #   "#ACA2BA" #AECDE1"
  # ))  +
  scale_fill_brewer(type="qual", palette = 3) +
  labs( title = "TOPICS by TASK and DATASET",
        subtitle = "Number of Utterances differs across Task and Datset",
        caption = "Relative distribution of Topics is similar across factors excepting IXN-Happiness",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal())
# + theme(legend.position = "blank")

ggsave(p, file="figures/UTTERANCE_topics_by_factors.png")


```

*NOTE: Here we see an interesting pattern in the IXN-HAPPINESS dataset, where there are far fewer utterances about VARIABLES and more utterances about RELATIONSHIPS. Analysts believe this is likely* a result of using INTERACTIVE-PROFILE visualization, where participants seemed to skip over characterization of the univariate distributions in favor of observing or speculating about the potential relationships *between* variables while actively scrubbing across one of the profiler histograms.

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT 
ctable(x = df_coded$PNUM, 
       y = df_coded$code_topic, 
       prop = "r")  

#PAPER FIGURE HERE
#TOPICS by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_topic), data = df_coded) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal())

ggsave(p, file="figures/UTTERANCE_topics_by_participant.png")



# #TOPICS by PARTICPANT facet TASK
# gf_bar( PNUM ~., fill = ~ fct_rev(code_topic), data = df_coded) %>%
#   gf_facet_grid(DATASET~TASK) +
#   scale_fill_brewer(type="qual", palette = 3) +
#   labs(
#     title = "Utterances by Participant, Dataset and Task",
#     subtitle = "",
#     x = "number of coded utterances",
#     y = "participant",
#     fill = "DATASET"
#   )
```

*NOTE: There appear to be substantial individual differences in the number* of utterances participants generate, and to some extent to the high level *topic* of the utterances. It is possible, however, this is also related to individuals' relative familiarity/interest in exploring data with numeric vs. nominal outcome variables. Both data analysts noted participants (in general) seemed to struggle more in choosing and interpreting representations aimed at representing relationships with nominal variables.

### by TIME

```{r, message=FALSE}

#HISTOGRAMS BY TASK
ggplot(df_coded, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density.., fill = fct_rev(code_topic), color = fct_rev(code_topic))) + 
  geom_density()+
  facet_grid(df_coded$code_topic ~ df_coded$TASK) +
  scale_fill_brewer(type="qual", palette = 3) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Topic of Utterance over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
    fill = "Topic"
  ) + theme_minimal() + theme(legend.position = "blank")



#DOTPLOT — PARTICIPANT FACET
# (p <- ggplot(df_coded, aes(x=relative_time, y = PNUM, color=fct_rev(code_topic))) + 
#   geom_point(alpha=0.5, size=3) +
#   facet_grid(df_coded$TASK) +
#   scale_color_brewer(type="qual", palette = 3) +
#   theme_minimal() + labs(
#     title = "Topic of Utterances over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "Task",
#     color = "Topic"
#   ))
# ggsave(p, file="figures/UTTERANCE_topics_by_time_FACET.png")

#PAPER FIGURE HERE
#DOTPLOT TASK STACKED
(p <- ggplot(df_coded, aes(x=relative_time, y = fct_rev(TASK), color=fct_rev(code_topic))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_coded$PNUM) +
  # facet_grid(df_coded$TASK ~ df_coded$DATASET) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Topic of Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
)) 
ggsave(p, file="figures/UTTERANCE_topics_by_time_STACK.png")




```

## [DETAIL of] Utterances

NEXT we explore the distribution of specific detail utterances across Analysis Task, Dataset, Participant and Time.

We organize these sections according to the high-level topic codes: (ANALYSIS) PROCESS, DATASET, VARIABLE, RELATIONSHIP

***RQ: What specific things did participants talk aloud during EDA? Are there any details folks only*** **mention during static(v)interactive, or nominal(v)numeric tasks? Any substantial changes in proportion by TASK or DATASET?**

### PROCESS UTTERANCES

#### PROCESS Utterances

```{r, message=FALSE}

#PREP DATA FRAMES
df_process <- df_coded %>% 
  filter(code_topic=="PROCESS") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_process <- df_coded %>% 
  filter(code_topic=="PROCESS") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_process %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_process %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  labs( title = "PROCESS Utterances by TASK",
        subtitle = "",
        caption = "weak to moderate difference in PROCESS utterances by TASK, \n but these do not seem substantial when broken into the two categories",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  labs( title = "PROCESS Utterances by DATASET",
        subtitle = "",
        caption = "much more substantial differences in PROCESS utterances by DATASET, \n consistent with intution Ps had more to say about the numeric (vs) nominal outcome variable",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_process, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_process$TASK) +
  scale_color_manual(values = c("#C4B6D9","#957EB4"))+
  # scale_color_brewer(type="seq", palette = "PuRd") +
  theme_minimal() + labs(
    title = "PROCESS Utterances by timecourse of Task",
    caption = "appear randomly distributed through time \n expected and reasonable given PROCESS utterances are meta-level",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_process, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_process$TASK ~ df_time_process$code_detail ) +
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  theme_minimal() + labs(
    title = "PROCESS Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")


#PAPER FIGURE HERE
#PROCESSES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ (code_detail), data = df_process) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  # scale_fill_brewer(palette = "PRGn", direction=-1) +
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  labs(
    title = "PROCESS Utterances by Participant and Task",
    subtitle = "",
    # caption = "TODO explore P13 representation comments",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()
)

ggsave(p, file="figures/UTTERANCE_detail_PROCESS_participants.png", width=6, height=4)


```

*NOTE: Across TASKS and DATASET participants had more to say about Representations* than their *Plans of Action*. Both kinds of PROCESS utterances were more or less evenly distributed across the timecourse of the tasks.

#### PROCESS Representations

THIS SECTION covers representations EXPLICITLY LINKED to UTTERANCES. Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances.

```{r}

#FILTER JOINED DATAFRAME
df <- df_codedrep %>% filter(code_topic =="PROCESS")


#DETAIL REP TYPE
(p <- gf_bar( rep_type ~., fill = ~ fct_rev(code_detail), data = df) %>%
  gf_facet_grid(DATASET~TASK) +
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  labs(
    title = "PROCESS Utterance-Representations (TYPE) ",
    subtitle = "",
    caption = "",
    x = "number of coded utterances",
    y = "Representation Type",
    fill = "(code_detail)"
  ) + theme_minimal()
)

#PAPER FIGURE
#DETAIL REP DETAIL
(p <- gf_bar(  ~ rep_simple, fill = ~(code_detail), data = df) %>% 
  gf_facet_grid( DATASET ~ TASK) + 
  # scale_fill_brewer(type="qual", palette = 1, direction = -1) +
  scale_fill_manual(values = c("#C4B6D9","#957EB4"))+
  coord_flip() + 
  scale_x_discrete(limits = c(
           "multi-view chart",
           "heatmap",
           "pairplot",
           "stripplot",
           "lineplot",
           "scatterplot",
           "barplot",
           "profile",
           "histogram",
           "CODE",
           "TABLE",
           "NONE"
  ))+
  theme_minimal() + labs(
    title = "PROCESS Utterance-Representations (DETAIL)"
))

ggsave(p, file="figures/UTTERANCE-REP_detail_PROCESS_factors.png", width=6, height=4)


#FILTER ON ONLY ACTIVELY USING IXN
df <- df_codedrep %>% filter(code_topic == "PROCESS") %>% filter(TASK=="ixn")

#PAPER FIGURE
#DOTPLOT—IXN
( p <- ggplot(df, aes(x=relative_time, y = PNUM, color = ixn)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df$DATASET) +
  # scale_color_brewer(type="qual", palette = 3) +
  scale_color_manual(values=c("black","#D81897")) +
  theme_minimal() + labs(
    title = "PROCESS Utterances USING INTERACTION",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "USING IXN"
  ))


ggsave(p, file="figures/IXN_PROCESS_time.png", width=6, height=4)

```

### DATASET UTTERANCES

#### DATASET Utterances

```{r, message=FALSE}

#PREP DATA FRAMES
df_dataset <- df_coded %>% 
  filter(code_topic=="DATASET") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_dataset <- df_coded %>% 
  filter(code_topic=="DATASET") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_dataset %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_dataset %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = "Greens") +
  # scale_fill_brewer(type="seq", palette = 4) +
  labs( title = "DATASET Utterances by TASK",
        subtitle = "",
        caption = "notable decrease MISSING DATA utterances in IXN \n unsure what might explain this, explore at individual level",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = "Greens") +
  # scale_fill_brewer(type="seq", palette = 4) +
  labs( title = "DATASET Utterances by DATASET",
        subtitle = "",
        caption = "minor differences by DATASET  reasonable given DATASET \n  represenations are typically tabluar (data dictionary, describe, head/tail)",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_dataset, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_dataset$TASK) +
  scale_color_brewer(type="seq", palette = "Greens") +
  # scale_color_brewer(type="seq", palette = 4) +
  theme_minimal() + labs(
    title = "DATASET Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    caption = "notable sparsity in center of timecourse, reasonable as EDA normative behavior \n is to consider dataframe shape and missing data at the start of an analysis",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_dataset, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_dataset$TASK ~ df_time_dataset$code_detail ) +
  scale_fill_brewer(type="seq", palette = "Greens") +
  # scale_fill_brewer(type="seq", palette = 4) +
  theme_minimal() + labs(
    title = "DATASET Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
        caption = "sensical that the most uniformly distributed detail code is missing data \n as this can be discovered via graphing",
  ) + theme_minimal() + theme(legend.position = "blank")


#PAPER FIGURE HERE
#DATASET UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ (code_detail), data = df_dataset) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="seq", palette = "Greens") +
  labs(
    title = "DATASET Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC",
    # caption = "P11, P12 contribute to MISSING DATA \n P9 contributes largely to variable metadata \n INVESTIGATE FURTHER",
  ) + theme_minimal()
)

ggsave(p, file="figures/UTTERANCE_detail_DATASET_participants.png",width=6, height=4)



```

#### DATASET Representations

THIS SECTION covers representations EXPLICITLY LINKED to UTTERANCES. Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances.

```{r}

df <- df_codedrep %>% filter(code_topic =="DATASET")

#DETAIL REP TYPE
(p <- gf_bar( rep_type ~., fill = ~ fct_rev(code_detail), data = df) %>%
  gf_facet_grid(DATASET~TASK) +
  scale_fill_brewer(type="seq", palette = "Greens") +
  # scale_fill_brewer(type="seq", palette = "PuRd") +
  labs(
    title = "DATASET Utterance-Representations (TYPE) ",
    subtitle = "",
    caption = "",
    x = "number of coded utterances",
    y = "Representation Type",
    fill = "(code_detail)"
  ) + theme_minimal()
)

#PAPER FIGURE
(p <- gf_bar(  ~ rep_simple, fill = ~(code_detail), data = df) %>% 
  gf_facet_grid( DATASET ~ TASK) + 
  scale_fill_brewer(type="seq", palette = "Greens") +
  coord_flip() + 
  scale_x_discrete(limits = c(
           "multi-view chart",
           "heatmap",
           "pairplot",
           "stripplot",
           "lineplot",
           "scatterplot",
           "barplot",
           "profile",
           "histogram",
           "CODE",
           "TABLE",
           "NONE"
  ))+
  theme_minimal() + labs(
    title = "DATASET Utterance-Representations (DETAIL)"
))

ggsave(p, file="figures/UTTERANCE-REP_detail_DATASET_factors.png", width=6, height=4)




df <- df_codedrep %>% filter(code_topic == "DATASET") %>% filter(TASK=="ixn")

#PAPER FIGURE
#DOTPLOT—IXN
( p <- ggplot(df, aes(x=relative_time, y = PNUM, color = ixn)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df$DATASET) +
  scale_color_manual(values=c("black","#D81897")) +
  theme_minimal() + labs(
    title = "DATASET Utterances USING INTERACTION",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "USING IXN"
  ))


ggsave(p, file="figures/IXN_DATASET_time.png", width=6, height=4)


```

### VARIABLE UTTERANCES

#### VARIABLE Utterances

```{r, message=FALSE}

#PREP DATA FRAMES
df_variable <- df_coded %>% 
  filter(code_topic=="VARIABLE") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_variable <- df_coded %>% 
  filter(code_topic=="VARIABLE") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_variable %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_variable %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  # scale_fill_brewer(type="seq", palette = 5) +
  labs( title = "VARIABLE Utterances by TASK",
        subtitle = "",
        caption = "notably more RANGE obs in STATIC than INTERACTIVE \n TODO consider collapsing distribution-variance ",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="seq", palette = 5) +
  scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  labs( title = "VARIABLE Utterances by DATASET",
        caption = "Notably more SHAPE in SPACE than HAPPINESS \n notably fewer RANGE in SPACE than HAPPINESS \n TODO are shape and range normalized across variable types? ",
        subtitle = "",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_variable, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_variable$TASK) +
  # scale_color_brewer(type="seq", palette = 5) +
  scale_color_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  theme_minimal() + labs(
    title = "VARIABLE Utterances by timecourse of Task",
    caption = "IXN appears more BIMODAL than STATIC where the distribution is more uniform",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_variable, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_variable$TASK ~ df_time_variable$code_detail ) +
  # scale_fill_brewer(type="seq", palette = 5) +
  scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  theme_minimal() + labs(
    title = "VARIABLE Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")

#PAPER FIGURE HERE
#VARIABLE UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ (code_detail), data = df_variable) %>% 
  gf_facet_grid(.~TASK) + 
  # scale_fill_brewer(type="seq", palette = 5) +
  scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  labs(
    title = "VARIABLE Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC",
    # caption = "substantial individual differences, most everyone made some comments \n at some point about distribution shape, but \n discussion of outliers, variance and range was more idiosyncratic \n TODO INVESTIGATE P4 STATIC RANGE very high",
  ) + theme_minimal()
)

ggsave(p, file="figures/UTTERANCE_detail_VARIABLE_participants.png", width=6, height=4)


```

#### VARIABLE Representations

THIS SECTION covers representations EXPLICITLY LINKED to UTTERANCES. Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances.

```{r}


df <- df_codedrep %>% filter(code_topic =="VARIABLE")


#DETAIL REP TYPE
gf_bar( rep_type ~., fill = ~ fct_rev(code_detail), data = df) %>%
 gf_facet_grid(DATASET~TASK) +
 scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  labs(
    title = "VARIABLE Utterance-Representations (TYPE) ",
    subtitle = "",
    caption = "",
    x = "number of coded utterances",
    y = "Representation Type",
    fill = "(code_detail)"
  ) + theme_minimal()

(p <- gf_bar(  ~ rep_simple, fill = ~(code_detail), data = df) %>% 
  gf_facet_grid( DATASET ~ TASK) + 
  scale_fill_manual(values=c("#5AB4AC","#AED8D2","#03655E"))+
  coord_flip() + 
  scale_x_discrete(limits = c(
           "multi-view chart",
           "heatmap",
           "pairplot",
           "stripplot",
           "lineplot",
           "scatterplot",
           "barplot",
           "profile",
           "histogram",
           "CODE",
           "TABLE",
           "NONE"
  ))+
  theme_minimal() + labs(
    title = "VARIABLE Utterance-Representations (DETAIL)"
))

ggsave(p, file="figures/UTTERANCE-REP_detail_VARIABLE_factors.png", width=6, height=4)


df <- df_codedrep %>% filter(code_topic == "VARIABLE") %>% filter(TASK=="ixn")

#PAPER FIGURE
#DOTPLOT—IXN
( p <- ggplot(df, aes(x=relative_time, y = PNUM, color = ixn)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df$DATASET) +
  scale_color_manual(values=c("black","#D81897")) +
  theme_minimal() + labs(
    title = "VARIABLE Utterances USING INTERACTION",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "USING IXN"
  ))


ggsave(p, file="figures/IXN_VARIABLE_time.png", width=6, height=4)


```

### RELATIONSHIP UTTERANCES

#### RELATIONSHIP Utterances

```{r, message=FALSE}

#PREP DATA FRAMES
df_relationship <- df_coded %>% 
  filter(code_topic=="RELATIONSHIP") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_relationship <- df_coded %>% 
  filter(code_topic=="RELATIONSHIP") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_relationship %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_relationship <- df_relationship %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="seq", palette = 3) +
  scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  labs( title = "RELATIONSHIP Utterances by TASK",
        subtitle = "",
        caption = "TODO think about proportion of existence and strength/direction",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_relationship, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="seq", palette = 3) +
  scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  labs( title = "RELATIONSHIP Utterances by DATASET",
        subtitle = "",
        caption = "substantial differences by DATASET, \n consistent with pattern of results with VARIABLE utterances \n perhaps due to sparsity of knowledge of analysis of nominal X nominal relationships, and tool coverage",
        x= "DATASET", y = "count") + theme_minimal() 

#DETAILS DOTPLOT
ggplot(df_time_relationship, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_relationship$TASK) +
  # scale_color_brewer(type="seq", palette = 3) +
  scale_color_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterances by timecourse of Task",
    caption = "uniformly distributed, as expected \n may see variance if dimension of HYPOTHESIS vs OBSERVATION was coded",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_relationship, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_relationship$TASK ~ df_time_relationship$code_detail ) +
  # scale_fill_brewer(type="seq", palette = 3) +
  scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")

#PAPER FIGURE HERE
#RELATIONSHIP UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ (code_detail), data = df_relationship) %>% 
  gf_facet_grid(.~TASK) + 
  # scale_fill_brewer(type="seq", palette = 1) +
  scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  labs(
    title = "RELATIONSHIP Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()
)

ggsave(p, file="figures/UTTERANCE_detail_RELATIONSHIP_participants.png", width=8, height=4)

```

#### RELATIONSHIP Representations

THIS SECTION covers representations EXPLICITLY LINKED to UTTERANCES. Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances.

```{r}


df <- df_codedrep %>% filter(code_topic =="RELATIONSHIP")

#DETAIL REP TYPE
gf_bar( rep_type ~., fill = ~ fct_rev(code_detail), data = df) %>%
  gf_facet_grid(DATASET~TASK) +
  scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  labs(
    title = "RELATIONSHIP Utterance-Representations (TYPE) ",
    subtitle = "",
    caption = "",
    x = "number of coded utterances",
    y = "Representation Type",
    fill = "(code_detail)"
  ) + theme_minimal()


#PAPER FIGURE
(p <- gf_bar(  ~ rep_simple, fill = ~(code_detail), data = df) %>% 
  gf_facet_grid( DATASET ~ TASK) + 
 scale_fill_manual(values=c(
              "#C5D3DE",
              "#C0DCF1",
              "#90CBE4",
              "#4EB0DA",
              "#0083C2",
              "#0051A1"))+
  coord_flip() + 
  scale_x_discrete(limits = c(
           "multi-view chart",
           "heatmap",
           "pairplot",
           "stripplot",
           "lineplot",
           "scatterplot",
           "barplot",
           "profile",
           "histogram",
           "CODE",
           "TABLE",
           "NONE"
  ))+
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterance-Representations (DETAIL)"
))

ggsave(p, file="figures/UTTERANCE-REP_detail_RELATIONSHIP_factors.png", width=8, height=4)



df <- df_codedrep %>% filter(code_topic == "RELATIONSHIP") %>% filter(TASK=="ixn")

#PAPER FIGURE
#DOTPLOT—IXN
( p <- ggplot(df, aes(x=relative_time, y = PNUM, color = ixn)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df$DATASET) +
  scale_color_manual(values=c("black","#D81897")) +
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterances USING INTERACTION",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "USING IXN"
  ))


ggsave(p, file="figures/IXN_RELATIONSHIP_time.png", width=6, height=4)


```

# EXPLORE UTTERANCE REPRESENTATIONS

*NOTE: A finer-grained view of representations used when making particular kinds of utterances is addressed in the DETAIL of Utterances subsections of EXPLORE UTTERANCES (directly above). Here we address only an overview of the _type_ of representations created by the structural factors in the study. 

This section covers representations EXPLICITLY LINKED to UTTERANCES. Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances.


## [CATEGORY of] Representation

### by TASK and DATASET

```{r results="asis", message=FALSE}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_codedrep %>%
  group_by(rep_type, TASK,DATASET) %>%
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(rep_type))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "UTTERANCE-REPS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal()
# + theme(legend.position = "blank")

```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT 
ctable(x = df_codedrep$PNUM, 
       y = df_codedrep$rep_type, 
       prop = "r")  

#TOPICS by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_codedrep) %>% 
  gf_facet_grid(DATASET~TASK) + 
  scale_fill_brewer(type="qual", palette = 4) +
  labs(
    title = "Utterance-Represenations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of representations",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal())

# ggsave(p, file="figures/utterance_reptypes_by_count.png")

```

### by TIME

```{r}

#HISTOGRAMS BY TASK
ggplot(df_codedrep, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density.., fill = fct_rev(rep_type), color = fct_rev(rep_type))) + 
  geom_density()+
  facet_grid(df_codedrep$rep_type ~ df_codedrep$TASK) +
  scale_fill_brewer(type="qual", palette = 4) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "UTTERANCE-REPS over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterance-reps",
    fill = "Topic"
  ) + theme_minimal() + theme(legend.position = "blank")



#DOTPLOT — FACET TASK
(p <- ggplot(df_codedrep, aes(x=relative_time, y = PNUM, color=fct_rev(rep_type))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_codedrep$TASK) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "Utterance-Reps over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Task",
    color = "Topic"
  )) 
ggsave(p, file="figures/UTTREP_classes_by_time_FACET.png")

#DOTPLOT STACKED TASKS
(p <- ggplot(df_codedrep, aes(x=relative_time, y = fct_rev(TASK), color=fct_rev(rep_type))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_codedrep$PNUM) +
  # facet_grid(df_codedrep$TASK ~ df_codedrep$DATASET) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "Utterance-Reps over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
)) 
ggsave(p, file="figures/UTTREP_classes_by_time_STACK.png")



```

## [INTERACTING with ] Representations

This section explores the the relatively small number of utterancess that are flagged as occuring when interaction was ACTIVELY BEING USED SHOULD be a quick but effective.

```{r}

#DOTPLOT
df <- df_codedrep %>% filter(TASK=="ixn")
ggplot(df, aes(x=relative_time, y = fct_rev(TASK), color=ixn)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df$PNUM) +
  # facet_grid(df_codedrep$TASK ~ df_codedrep$DATASET) +
  scale_color_manual(values=c("black","#D81897")) +
  theme_minimal() + labs(
    title = "Utterance USING IXN during INTERACTIVE TASK",
    caption = "ordered by dataset, P6-P13 are SPACE, P5-P11 are HAPPINESS",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "IXV"
) 


```

```{r}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_codedrep %>%
  filter(TASK == "ixn") %>%  #can only occur during interactive task
  group_by(DATASET,code_topic,ixn) %>% 
  dplyr::summarise( .groups="keep",
    c = n()
  )

##no need to summarize by rep_type because only vis can be ixn
## consider middle level summary of uni vs bi vs multivariate vis 


#STACKED BAR BY TASK
ggplot(df_summary, aes(x = DATASET, y=c, fill= ixn)) + 
  geom_col() + 
  facet_wrap(df_summary$code_topic) + 
  # geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_manual(values=c("black","#D81897")) +
  labs( title = "KINDS of utterances made WHILE INTERACTING with ixn visualization",
        subtitle = "",
        x= "DATASET", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")


```

```{r}


df <- df_codedrep %>% dplyr::select(PNUM, TASK, DATASET, code_topic, code_detail, REP, rep_type, relative_time, ixn) %>% filter(TASK=="ixn")


gf_bar( ~REP , fill = ~ixn, data = df) %>% 
  gf_facet_grid(ixn ~ DATASET) + theme_minimal() + 
  labs( title = "Utterances WHILE INTERACTING with IXN representations")


df_summary <- df_codedrep %>% 
  filter(TASK == "ixn") %>%  #can only occur during interactive task
  group_by(DATASET,REP,ixn) %>% 
  summarise( .groups = "keep",
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = REP, y=c, fill= ixn, alpha = 0.75)) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  coord_flip()+
  geom_text(aes(label=c),  alpha = 1, size = 3, hjust = 1.25, vjust = 0.75, position = "stack") +
  scale_fill_manual(values=c("black","#D81897")) +
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "Utterances WHILE INTERACTING with IXN representations",
        subtitle = "",
        x= "", y = "count", fill="interacting?") + theme_minimal()
# + theme(legend.position = "blank")
```


# EXPLORE TELEMETRY REPRESENTATIONS

**Representations** are computationally-generated visual-spatial artifacts that participants use during the EDA tasks. These include data visualizations, but also tabular code outputs, or other data structures returned by Python code.

NOTE that there are three uses of representations we explore in this project:

1.  Representations *used or referenced* during the course of making an utterance. These representations are explored in the [DETAIL of] Utterances sections (above).
2.  Representations *used interactively* during the course of making an utterance. These include charts to which an interaction encoding is added via Altair Express, but *only* when they are *actively engaged* in while making an utterance. These are also explored in the [DETAIL of] Utterances sections (above).
3.  Representations created by participants during the analysis task. These are not necessarily associated with utterances. These are the representations we explore in this section, and they are derived from log-telemetry data.

In the following subsections we start by exploring the distribution of *kinds of representations* participants generated based on TASK, DATASET, and PARTICIPANT. [TELEMETRY] Representations

***RQ: How many representations did participants generate? Of what kinds? At what times during the process of analysis?*** (These are the representations coming from telemetry. Not connected to utterances explicitly. Code only reps are excluded, but tabular output of code cells (eg. .info(), .describe(), etc. included)

## [Number of] Representations

### by TASK

```{r results='asis'}

print("BY TASK")
freq(df_telemetry$TASK, 
     cumul      = FALSE,
     headings   = FALSE,
     report.nas = FALSE,
     plain.ascii = FALSE) 

```

### by TASK and DATASET

```{r}
#COUNT BY TASK AND DATASET
ctable(x = df_telemetry$TASK, 
       y = df_telemetry$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>% 
  group_by(TASK,DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK AND DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "(Telemetry) Representations by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")
```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT AND TASK
ctable(x = df_telemetry$PNUM, 
       y = df_telemetry$TASK, 
       prop = "r")  

#UTTERANCES by PARTICPANT facet TASK color DATASET
gf_bar( PNUM ~., fill = ~ DATASET, data = df_telemetry) %>% 
  gf_facet_grid(.~TASK) + 
  labs(
    title = "(Telemetry) Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of logged representations",
    y = "participant",
    fill = "DATASET"
  )

```

### through TIME

```{r}

##TODO-INVESTIGATE TELEMETRY ROWS MISSING TIMESTAMP

# #DOTPLOT—PARTICIPANT-facet-TASK-color-DATASET
# ggplot(df_telemetry, aes(x=time_elapsed, y = PNUM, color = DATASET)) + 
#   geom_point(alpha=0.5, size=3) +
#   facet_grid(df_telemetry$TASK) +
#   # scale_color_brewer(type="qual", palette = 3) +
#   theme_minimal() + labs(
#     title = "Participant Utterances over timecourse of Task",
#     subtitle = "",
#     x= "timecourse of task (seconds)", y = "Participant",
#     color = "Dataset"
#   ) 
# 
# 
# #HISTOGRAMS BY TASK
# ggplot(df_telemetry, aes(x = time_elapsed)) + 
#   geom_histogram(binwidth = 30,aes(y=..density..)) + 
#   geom_density()+
#   facet_grid(df_telemetry$TASK) +
#   theme_minimal() + labs(
#     title = "(Telemetry) Representations over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "frequency of utterances",
#   ) + theme_minimal() + theme(legend.position = "blank")


```

## [CATEGORY of] Representation

### by TASK and DATASET

```{r, message=FALSE}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>%
  group_by(rep_type, TASK,DATASET) %>%
  dplyr::summarise(
    c = n()
  )

#PAPER FIGURE HERE
#STACKED BAR BY TASK FACET DATASET
(p <- ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(rep_type))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 1, direction = -1) +
  labs( title = "(TELEMETRY) REPRESENTATIONS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="REP-TYPE") + theme_minimal()
)

ggsave(p, file="figures/TELEMETRY_classes_by_factors.png")
# + theme(legend.position = "blank")

# #HIGH LEVEL
# gf_bar(  ~ rep_type, fill = ~rep_type, position="stack", data = df_telemetry) %>% 
#   gf_facet_grid( DATASET ~ TASK) +
#   scale_fill_brewer(type="qual", palette = 1) +
#   theme_minimal() + labs(
#     title = "[TELEMETRY]  Representations HIGH"
#   )

```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT 
ctable(x = df_telemetry$PNUM, 
       y = df_telemetry$rep_type, 
       prop = "r")  


#CATEGORY by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="qual", palette = 1, direction = -1) +
  labs(
    title = "(Telemetry) Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of logged representation",
    y = "participant",
    fill = "REP-TYPE"
  ) + theme_minimal())

ggsave(p, file="figures/TELEMETRY_classes_by_participants.png")




```

## [TYPE of] Representation

### by TASK and DATASET

```{r}


#COUNT BY TASK 
ctable(x = df_telemetry$REP, 
       y = df_telemetry$TASK, 
       prop = "t")  

#COUNT BY DATASET
ctable(x = df_telemetry$REP, 
       y = df_telemetry$DATASET, 
       prop = "t")  


#PAPER FIGURE HERE
#DETAIL
(p <- gf_bar(  ~ REP, fill = ~fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_grid( DATASET ~ TASK) + 
  scale_fill_brewer(type="qual", palette = 1, direction = -1) +
  coord_flip() + 
  scale_x_discrete(limits = c( 
                          "multiviewchart",
                          "heatmap",
                          "pairplot",
                          "stripplot",
                          "lineplot",
                          "scatterplot",
                          "barplot",
                          "profile",
                          "hist",
                          "describe",
                          "info",
                          "columns",
                          "dataframe"
    
  ))+
  theme_minimal() + labs(
    title = "[TELEMETRY] Representations DETAIL by FACTORS",
    fill = "REP-TYPE"
))

ggsave(p, file="figures/TELEMETRY_detail_by_factors.png", width = 7, height = 5, units ="in")


#flipped
# gf_bar(  ~ REP, fill = ~fct_rev(rep_type), data = df_telemetry) %>% 
#   gf_facet_grid( TASK ~ DATASET) + 
#   scale_fill_brewer(type="qual", palette = 1, direction = -1) +
#   coord_flip() + 
#   scale_x_discrete(limits = c( 
#                           "multiviewchart",
#                           "heatmap",
#                           "pairplot",
#                           "stripplot",
#                           "lineplot",
#                           "scatterplot",
#                           "barplot",
#                           "profile",
#                           "hist",
#                           "describe",
#                           "info",
#                           "columns",
#                           "dataframe"
#     
#   ))+
#   theme_minimal() + labs(
#     title = "[TELEMETRY]  Representations DETAIL by FACTORS"
# )

# #DF BY REP
# df_summary <- df_telemetry %>% 
#   group_by(REP) %>% 
#   dplyr::summarise(
#     c = n()
#   )

# #STACKED BAR 
# ggplot(df_summary, aes(x = REP, y=c, fill= REP)) + 
#   geom_col() + 
#   geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
#   # scale_fill_brewer(type="qual", palette = 4) +
#   coord_flip()+
#   labs( title = "(Telemetry) Representations DETAIL",
#         subtitle = "",
#         x= "TASK", y = "count") + theme_minimal() 
# # + theme(legend.position = "blank")




```
### by PARTICIPANT
```{r}


#REPRESENTATIONS by PARTICPANT
(p <- gf_bar( REP ~., fill = ~ fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_wrap(~ PNUM ) + 
  scale_fill_brewer(type="qual", palette = 1, direction = -1) +
  labs(
    title = "(Telemetry) Representations by Participant",
    subtitle = "",
    y = "Representation",
    fill = "REP-TYPE"
  ) + theme_minimal()
)


```


# MODELLING

*(limited) Data modelling to explore post-hoc hypotheses.*

```{r VIZ-B4-MODEL, message=FALSE}

#DEFINE DATAFRAME
df <- df_coded %>% select(pid, uid, TASK, DATASET) 
  
# #MOSAIC PLOT
# mosaic(formula = ~DATASET + TASK, 
#        data = df,
#        main = "Proportion of Utterances by TASK and DATASET", 
#        sub = "u = 734 utterance-codes",
#        labeling = labeling_values,
#        labeling_args = list(set_varnames = c(graph = "TASK",
#                             datset = "DATASET")))




```

## Predicting NUMBER of UTTERANCES

*How much variance in number of utterances is explained DATASET, TASK and PARTICIPANT?*

### OLS Mixed Effects Model

```{r OLS-MIXED-EFFECTS-MODELS}

#DEFINE DATAFRAME
df <- df_coded %>% group_by(pid, DATASET, TASK) %>% 
  dplyr::summarise( .groups = "keep",
    n_utterances = n()
  )

#NUMBER UTTERANCES predicted by DATASET + TASK | participatnt--> MIXED LINEAR REGRESSION
print("LMER, UTTERANCES ~ DATASET + TASK")
mm1 <- lmer(n_utterances ~ DATASET + TASK+ (1|pid), data = df)
paste("Model")
summ(mm1)
paste("Partition Variance")
anova(mm1)
paste("Confidence Interval on Parameter Estimates")
confint(mm1)
report(mm1) #sanity check
plot_model(mm1,  show.intercept = TRUE)
check_model(mm1)


#NUMBER UTTERANCES predicted by DATASET * TASK  | participatnt--> MIXED LINEAR REGRESSION
print("LMER, UTTERANCES ~ DATASET X TASK")
mm2 <- lmer(n_utterances ~ DATASET * TASK + (1|pid), data = df)
paste("Model")
summ(mm2)
paste("Partition Variance")
anova(mm2)
paste("Confidence Interval on Parameter Estimates")
confint(mm2)
report(mm2) #sanity check
plot_model(mm2,  show.intercept = TRUE)
check_model(mm2)
```

```{r POISSON-MIXED-EFFECTS-MODELS}
### POISSON Mixed Effects Models
### ARF poisson is recommended over OLS regression for count data 
### BUT they are challenging to interpret (log odds) and the estimates need to be translated (logodds?)
### NOT innapropriate to use OLS instead
# 
# #NUMBER UTTERANCES predicted by TASK + DATASET  | participatnt--> POISSON MIXED LINEAR REGRESSION
# print("POISSON-MER, UTTERANCES ~ DATASET + TASK")
# pmm1 <- glmer(n_utterances ~ TASK + DATASET + (1|pid), data = df, family = "poisson")
# paste("Model")
# summ(pmm1)
# paste("Partition Variance")
# anova(pmm1)
# paste("Confidence Interval on Parameter Estimates")
# confint(pmm1)
# report(pmm1) #sanity check
# plot_model(pmm1,  show.intercept = TRUE)
# check_model(pmm1)
# 
# #NUMBER UTTERANCES predicted by TASK X DATASET  | participatnt--> POISSON MIXED LINEAR REGRESSION
# print("POISSON-MER, UTTERANCES ~ DATASET X TASK")
# pmm2 <- glmer(n_utterances ~ TASK * DATASET + (1|pid), data = df, family = "poisson")
# paste("Model")
# summ(pmm2)
# paste("Partition Variance")
# anova(pmm2)
# paste("Confidence Interval on Parameter Estimates")
# confint(pmm2)
# report(pmm2) #sanity check
# plot_model(pmm2,  show.intercept = TRUE)
# check_model(pmm2)

```



# WIP

Especially missing further analysis on what interactions are actually created (telemetry) and used (rep-utterances)

```{r}

#COUNT BY TASK 
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$TASK, 
       prop = "t")  

#COUNT BY TASK AND DATASET
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>% 
  group_by(rep_type, TASK,DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK AND DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) + 
  geom_col() + 
  facet_grid(TASK ~ DATASET)+
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "(Telemetry) Representations by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")

#DF BY REP
df_summary <- df_telemetry %>% 
  group_by(rep_type, TASK, DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR 
ggplot(df_summary, aes(x = rep_type, y=c, fill= rep_type)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "(Telemetry) Representations DETAIL",
        subtitle = "",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")



#ALL Representations by task/dataset + made interactive
gf_bar(  ~ REP, fill = ~IXN, data = df_telemetry) %>% 
  gf_facet_grid( DATASET ~ TASK) + coord_flip() + 
  theme_minimal() + labs(
    title = "ALL Representations by task/dataset + made interactive"
  )





gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of representations",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()

gf_bar( PNUM ~., fill = ~ fct_rev(DATASET), data = df_telemetry) %>% 
  gf_facet_grid(REP~.) + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of representations",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()


#ALL Representations by task/dataset + made interactive
gf_bar(  ~ REP, fill = ~rep_type, data = df_telemetry) %>% 
  gf_facet_grid( DATASET ~ TASK) + coord_flip() + 
  scale_fill_brewer(type="qual", palette = 1) +
  theme_minimal() + labs(
    title = "ALL Representations by task/dataset by REP TYPE"
  )

```

### ADDING INTERACTIONS

```{r}
#ADDED INTERACTION
df <- df_telemetry %>% filter(rep_type=="CHART")
gf_bar(~ IXN, fill = ~IXN,data = df %>% filter(TASK=="ixn")) %>% 
  gf_facet_grid(DATASET~REP) + 
  scale_fill_brewer(type="qual", palette = 2, direction = -1) +
  theme_minimal() + labs(
    title = "Where do participants add Interaction?",
    subtitle="(during the Interactive Task) which visualizations are made interactive?",
    caption = "TODO INVESTIGATE where is profiler seems really low \n added ixn here means they added an ixn technique",
    fill = "added ixn"
  )


df <- df_telemetry %>% filter(rep_type=="CHART")
gf_bar(~ REP, fill = ~IXN,data = df %>% filter(TASK=="ixn")) %>% 
  gf_facet_grid(DATASET~.) +
  coord_flip()+
  scale_fill_brewer(type="qual", palette = 2, direction = -1) +
  theme_minimal() + labs(
    title = "Where do participants add Interaction?",
    subtitle="(during the Interactive Task) which visualizations are made interactive?",
    caption = "TODO INVESTIGATE where is profiler seems really low \n added ixn here means they added an ixn technique",
    fill = "added ixn"
  )

```

### TODO IXN TECHNIQUES

```{r}
freq(df_telemetry$technique)

gf_bar(~technique, data = df_telemetry) + coord_flip()
```

### TYPES by TASK

```{r results='asis'}

#TYPES by TASK
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$TASK, 
       prop = "t")   # Show row proportions


#REPS by TASK
ctable(x = df_telemetry$REP, 
       y = df_telemetry$TASK, 
       prop = "t")   # Show row proportions
```

### TYPES by DATASET

```{r results='asis'}

#TYPES by DATASET
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$DATASET, 
       prop = "t")   


#REPS by DATASET
ctable(x = df_telemetry$REP, 
       y = df_telemetry$DATASET, 
       prop = "t")   
```

### by PARTICIPANT --- TOTAL

```{r results="asis", message=FALSE}

#REPS by PARTICPANT facet TASK
gf_bar( PNUM ~., fill = ~ DATASET, data = df_telemetry) %>% 
  gf_facet_grid(.~TASK) + 
  labs(
    title = "Telemetry Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of REPRESENTATIONS",
    y = "participant",
    fill = "DATASET"
  ) + scale_fill_brewer(type="qual", palette = 2) + theme_minimal()

```

### by PARTICIPANT --- TYPE

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT AND TASK
ctable(x = df_telemetry$PNUM, 
       y = df_telemetry$rep_type, 
       prop = "r")  

#REPS by PARTICPANT facet TASK
gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_grid(DATASET~TASK) + 
  labs(
    title = "Telemetry Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of REPRESENTATIONS",
    y = "participant",
    fill = "REP-TYPE"
  ) + scale_fill_brewer(type="qual", palette = 1, direction = -1) + theme_minimal()

```

### TODO timestamps on telemetry needs cleaning

```{r}

# #DOTPLOT
# ggplot(df_coded, aes(x=relative_time, y = PNUM)) + 
#   geom_point(alpha=0.5, size=3) +
#   facet_grid(df_coded$TASK) +
#   scale_color_brewer(type="qual", palette = 3) +
#   theme_minimal() + labs(
#     title = "Participant Utterances over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "Participant",
#     color = "Topic"
#   ) 
# 
# 
# #HISTOGRAMS BY TASK
# ggplot(df_coded, aes(x = relative_time)) + 
#   geom_histogram(binwidth = 30,aes(y=..density..)) + 
#   geom_density()+
#   facet_grid(df_coded$TASK) +
#   theme_minimal() + labs(
#     title = "Participant Utterances over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "frequency of utterances",
#   ) + theme_minimal() + theme(legend.position = "blank")


```




# REPRODUCIBILITY

```{r}

#DOC R and package versions
sessionInfo()

#CITE R
citation()

```