---
title: "IXN 1 — Exploratory Data Analysis"
author: "ANONYMIZED"
date: "2023-09-08"
output:
  html_document:
    theme: flatly
    code_folding: hide
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    toc_depth: 5
  pdf_document:
    toc: yes
    toc_depth: '4'
always_allow_html: yes
font-family: DejaVu Sans
mainfont: DejaVu Sans
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#UTILITIES
library(Hmisc) # %nin% operator
library(tidyverse) #all the things
library(summarytools) #data quality
library(jtools) #Social Science regression utilities
library(lubridate) #dealing with dates

#VIZ
library(kableExtra) #printing tables
library(ggformula) #regression syntax viz
# library(vcd) #mosaic plots
# library(vcdExtra) #mosaic plot helpers
library(ggstatsplot) #dummies

#MODELLING
library(easystats) #modelling helpers
library(see)
library(sjPlot)
library(lme4)
library(lmerTest) #for CIs in glmer

options(readr.show_col_types = FALSE) #don't show coltypes on read_csv

```

```{r IMPORT, message=FALSE, warning=FALSE}

#IMPORT (wrangled) data 
df_raw_insights <- read_csv("data/CLEAN_coded_utterances.csv") 
df_raw_telemetry <- read_csv("data/arf_CLEAN_telemetry_representations.csv") 

##PRIMARY UTTERANCE DF
#NOT unique utterances, 1 obs for each utterance+detail-code
df_coded <- df_raw_insights %>% 
  #rename and factorize cols
  mutate(
    #UNIQUE IDS
    sid = factor(SID), #unique ID for utterance+detail-code
    pid = factor(PID, levels = c( #define level order so happiness first
      #HAPPINESS-FIRST    
      "bjs827ee1u", "3r2sh20ei", "4728sjuiz","7ACC0B75","92ghd48xe","iurmer289", "s294hoei",
      #SPACE-FIRST    
      "j2719eertu2","lkin27js09b","li832lin23","7382kwtue","E1D39056","8v892iige")),   
    #create unique ID for utterances
    uid = factor(as.numeric(factor(paste(pid,factor(Utterance))))), #construct a unique ID for utterances
    #recode lower case and order based on true task order
    TASK = factor(recode(Condition, "Static"="static", "Interactive"="ixn" )),
    TASK = factor(TASK, levels = c("static", "ixn")), #reorder factor levels
    #rename Notebook as DATASET
    DATASET = factor(recode(Notebook, "Happiness"="happiness", "Space"="space")),
    #create temp dataset order var
    data_order = factor(paste(TASK,"_",DATASET)), #create an order var 
    data_order = recode(data_order, "ixn _ happiness"="space-first",
                                    "ixn _ space"="happiness-first",
                                    "static _ happiness"="happiness-first",
                                    "static _ space"="space-first"),
    utterance = Utterance,
    reps_group = factor(Final_Group),
    reps_all = factor(`All representations`),
    #rename flags
    flag_story = `Dylan Flag Storytelling`,
    flag_correction = `Dylan Flag Correction`,
    flag_simultaneous = `Dylan Flag Simultaneous Characterization`,
    #recode and order TOP LEVEL CODES 
    code_topic = factor(Highlevel),
    code_topic = recode(code_topic, "ANALYSIS PROCESS" = "PROCESS"),
    code_topic = factor(code_topic, levels = c("PROCESS","DATASET","VARIABLE","RELATIONSHIP")),
    code_datatype = factor(`Data Type`),
    code_detail = factor(`Utterance Type`),
    timestamp = adj_timestamp,
    ixn = factor(interaction_used), #was interaction used?
    PNUM = factor(PNUM,levels = c("P6", "P9", "P10", "P2", "P4", "P12","P13", 
                                   "P5", "P7", "P8", "P3", "P1","P11")),
    
    ) %>% 
  dplyr::select(sid,pid,PNUM,uid,TASK,DATASET,timestamp,ixn,code_topic,code_detail,code_datatype,
         flag_story, flag_correction, flag_simultaneous, utterance, reps_group, reps_all, data_order) %>% 
  arrange(data_order)

#REPLACE NA in logicals to FALSE  
df_coded$flag_story[is.na(df_coded$flag_story)] <- FALSE
df_coded$flag_correction[is.na(df_coded$flag_correction)] <- FALSE
df_coded$flag_simultaneous[is.na(df_coded$flag_simultaneous)] <- FALSE



##NOW WRANGLE TIME INFO
# #CALCULATE RELATIVE TASK TIMES
df_coded <- df_coded %>% mutate(
  time = hms::as_hms(timestamp)
) %>% group_by(pid, TASK) %>%
  # dplyr::summarise( .groups="keep",
  mutate(
    task_start = hms::as_hms(min(time)),
    task_end = hms::as_hms(max(time)),
    task_mins = round(difftime(task_end,task_start, units="mins"),1),
    task_second = task_end - task_start,
    relative_time_s = timestamp-task_start,
    relative_time = as.double(relative_time_s)
  ) %>% ungroup() 
# %>%  dplyr::select(pid,PNUM, code_topic,code_detail, TASK,DATASET,timestamp,task_start,relative_time_s,relative_time)


##JOINED REPRESENATIONS DURING UTTERANCES DF
#START with REPRESENTATIONS associated with UTTERANCES
#ROW is unique utterance + rep combination
#many-many relationship between utterances and representations
df_joined <- df_coded %>% 
  dplyr::select(-data_order,-utterance, -flag_story, -flag_correction) %>% 
  mutate(
    #replace "data_dictionary" with dictionary
    #rename "Multi-view Chart"          
    reps_group  = factor(str_replace(reps_group, "data_dictionary", "dictionary")),
    reps_group  = factor(str_replace(reps_group, "Multi-view Chart", "multiviewchart")),                         
    reps_multi  = str_detect(reps_group,"_")) %>%  #flag multiple-representations 
  separate_longer_delim(reps_group, delim = "_") %>% #pivot longer based _ in reps_group
  mutate (REP = factor(reps_group)) %>% 
  dplyr::select(-reps_group) %>%  #drop reps_group column since now separated
  mutate(
    rep_type = recode(REP, 
                      "hist" = "VIS",                      
                      "profile" = "VIS",                   
                      "scatterplot" = "VIS",               
                      "barplot" = "VIS",                   
                      "stripplot" = "VIS",                 
                      "lineplot" = "VIS",                     
                      "heatmap" = "VIS",                    
                      "pairplot" = "VIS",                   
                      "multiviewchart" = "VIS",           
                      "double-profiler" = "VIS",           
                      "profile" = "VIS", 
                      "python" = "CODE",                    
                      "dictionary" = "CODE",   
                      "describe" = "CODE",
                      "dataframe" = "CODE",         
                      "info" = "CODE",                      
                      "columns" = "CODE",                  
                      "none"  ="NONE"     
  ))

##PRIMARY REPRESENATION DF
#ROW ==? 
df_telemetry <- df_raw_telemetry %>% 
  mutate(
  
    #PARTICIPANT DATA
    pid = factor(pID, levels = c( #define level order so happiness first
      #HAPPINESS-FIRST    
      "bjs827ee1u", "3r2sh20ei", "4728sjuiz","7ACC0B75","92ghd48xe","iurmer289", "s294hoei",
      #SPACE-FIRST    
      "j2719eertu2","lkin27js09b","li832lin23","7382kwtue","E1D39056","8v892iige")),   
    PNUM = factor(PNUM,levels = c("P6", "P9", "P10", "P2", "P4", "P12","P13", 
                                   "P5", "P7", "P8", "P3", "P1","P11")),
    

    
    TASK = factor(TASK, levels = c("static", "ixn")), #reorder factor levels
    DATASET = factor(session, levels = c("happiness","space")),
    #create temp dataset order var
    data_order = factor(paste(TASK,"_",DATASET)), #create an order var 
    data_order = recode(data_order, "ixn _ happiness"="space-first",
                                    "ixn _ space"="happiness-first",
                                    "static _ happiness"="happiness-first",
                                    "static _ space"="space-first"),
    timestamp = timestamp,
    time_elapsed = time_elapsed,
    technique = factor(`Interaction_Techniques`),
    IXN = (technique!="none"),
                         
    code = cell_content,
    REP = factor(merged_output_type),
    REP = factor(str_replace(REP, "Multi-view Chart", "multiviewchart"))) %>% 
  filter( #EXCLUDE SOME REPS
    #none and other are python code not of the tabular forms we look for
    REP %nin% c("none","error","markdown","other")
  ) %>% mutate(
    REP = factor(REP), #reset factor levels
    rep_type = recode(REP,
                      "dictionary" = "TABLE",   
                      "describe" = "TABLE",
                      "dataframe" = "TABLE",         
                      "info" = "TABLE",                      
                      "columns" = "TABLE",
                      "hist" = "VIS",                      
                      "profile" = "VIS",                   
                      "double-profiler" = "VIS",           
                      "countplot" = "VIS",
                      "barplot" = "VIS",                   
                      "scatterplot" = "VIS",               
                      "lineplot" = "VIS",                     
                      "stripplot" = "VIS",                 
                      "pairplot" = "VIS",                   
                      "heatmap" = "VIS",                    
                      "multiviewchart" = "VIS"
                      )) %>%      
  dplyr::select(pid,PNUM,TASK,DATASET,data_order,timestamp,time_elapsed,technique,IXN,REP,rep_type,cell_content)

```


# UTTERANCES PROFILE

There are `r nrow(df_coded)` rows in the `df_coded` dataset, where each row represents an utterance coding (i.e. utterance + detail code). There are `r nlevels(df_coded$uid)` *unique* utterances. The difference indicates utterances that were *dual-coded* (i.e. two detail-level codes). No more than two codes were applied to a single utterance. For the purposes of analysis, dual-coded utterances will be treated as two utterances, as they have two distinct (but lexically insepeperable) units of meaning.


```{r data-profile, results="asis", warning=FALSE, message=FALSE}

df_coded%>% summarytools::dfSummary(
             plain.ascii  = FALSE,
             graph.magnif = 0.75,
             style        = "grid",
             tmp.img.dir  = "temp",
             missing.col = FALSE, 
             method = "render"
)

```

*ARF has reviewed data profile for missing data and correct factorization.*


# REPRESENTATIONS PROFILE

There are `r nrow(df_telemetry)` rows in the `df_telemetry` dataset, where each row represents TODO 

There are TODO `r nlevels(df_coded$uid)` *unique* utterances. The difference indicates utterances that were *dual-coded* (i.e. two detail-level codes). No more than two codes were applied to a single utterance. For the purposes of analysis, dual-coded utterances will be treated as two utterances, as they have two distinct (but lexically insepeperable) units of meaning.


```{r REP-profile, results="asis", warning=FALSE, message=FALSE}

df_telemetry%>% summarytools::dfSummary(
             plain.ascii  = FALSE,
             graph.magnif = 0.75,
             style        = "grid",
             tmp.img.dir  = "temp",
             missing.col = FALSE, 
             method = "render"
)

```

*TODO ARF has reviewed data profile for missing data and correct factorization BUT wrangling needed on technique (pivotlonger) + need to normalize REP across barplot+countplot *


# UTTERANCES

**Utterances** are the lowest-level discrete units of meaning transcribed from the EDA Task transcripts. Utterances are coded at two levels of analysis: (1) **topic-code** gives a *high level* topic of the participant's verbalization, (2) **detail-code** gives the *lower level* detail of the subject.

In the following subsections we explore the distribution of *number of utterances* based on TASK, DATASET, and PARTICIPANT, before describing the distribution of utterances *through the timecourse* of the TASK.

## [Aggregated] Utterances

FIRST we explore the distribution of utterances by Analysis Task, Dataset, Participant and Time, irrespective of what the utterance was about (topic, detail).

***RQ: How much did participants talk aloud during EDA? When did they talk aloud?***

***Answer:** Inspection of frequency tables and visualizations suggests that the most substantial determinant of how many utterances an individual made is individual participant-level differences, rather than structural differences imposed by the TASK or DATASET. This is not altogether unexpected given the fact that across both tasks (static/interactive) and datasets the structure of the experimental task was the same*

### by TASK

```{r results='asis'}

print("BY TASK")
freq(df_coded$TASK, 
     cumul      = FALSE,
     headings   = FALSE,
     report.nas = FALSE,
     plain.ascii = FALSE) 

```

### by TASK and DATASET

```{r results="asis", message=FALSE}

#COUNT BY TASK AND DATASET
ctable(x = df_coded$TASK, 
       y = df_coded$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>% 
  group_by(TASK,DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "Utterances by TASK and DATASET",
        subtitle = "More utterances in STATIC; more utterances in HAPPINESS",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")

```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT AND TASK
ctable(x = df_coded$PNUM, 
       y = df_coded$TASK, 
       prop = "r")  

#UTTERANCES by PARTICPANT facet TASK
gf_bar( PNUM ~., fill = ~ DATASET, data = df_coded) %>% 
  gf_facet_grid(.~TASK) + 
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "DATASET"
  )

```

### through TIME

```{r}

#DOTPLOT
ggplot(df_coded, aes(x=relative_time, y = PNUM)) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_coded$TASK) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Participant Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 


#HISTOGRAMS BY TASK
ggplot(df_coded, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density..)) + 
  geom_density()+
  facet_grid(df_coded$TASK) +
  theme_minimal() + labs(
    title = "Participant Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
  ) + theme_minimal() + theme(legend.position = "blank")


```

## [TOPIC of] Utterances

NEXT we explore the distribution of utterances coded by high level TOPIC, across Analysis Task, Dataset, Participant and Time.

***RQ: What kinds of things did participants talk aloud during EDA? Did they progress through any 'topical phases' over the course of the task? Or are topics equally distributed across analysis time?***

***Answer:** Inspection of frequency tables and visualizations suggests that:*

1.  *Individual differences continue to play an important role*

2.  *There do not appear to be strong TASK/DATASET effects on topic that are consistent across participants.*

3.  *PROCESS and RELATIONSHIP topics are more evenly distributed across the timecourse of analysis, while DATASET AND VARIABLE topics are more tightly clustered near the beginning of the analysis. This pattern of distribution is sensical given what we know about EDA, and is consistent with the intuition that patterns of thought during EDA are likely more iterative and situational than we think (or model).*

### by TASK

```{r results='asis', message=FALSE}

#COUNT BY TASK
ctable(x = df_coded$code_topic, 
       y = df_coded$TASK, 
       prop = "r")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>% 
  group_by(code_topic, TASK) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(code_topic))) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs( title = "TOPICS by TASK",
        subtitle = "",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal() 
# + theme(legend.position = "blank")
```

### by TASK and DATASET

```{r results="asis", message=FALSE}


#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_coded %>%
  group_by(code_topic, TASK,DATASET) %>%
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(code_topic))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 3) +
  labs( title = "TOPICS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal()
# + theme(legend.position = "blank")

```

### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT 
ctable(x = df_coded$PNUM, 
       y = df_coded$code_topic, 
       prop = "r")  

#TOPICS by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_topic), data = df_coded) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="qual", palette = 3) +
  labs(
    title = "Utterances by Participant, Dataset and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal())

ggsave(p, file="figures/topics_by_count.png")



# #TOPICS by PARTICPANT facet TASK
# gf_bar( PNUM ~., fill = ~ fct_rev(code_topic), data = df_coded) %>% 
#   gf_facet_grid(DATASET~TASK) + 
#   scale_fill_brewer(type="qual", palette = 3) +
#   labs(
#     title = "Utterances by Participant, Dataset and Task",
#     subtitle = "",
#     x = "number of coded utterances",
#     y = "participant",
#     fill = "DATASET"
#   )
```

### by TIME

```{r}

#HISTOGRAMS BY TASK
ggplot(df_coded, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density.., fill = fct_rev(code_topic), color = fct_rev(code_topic))) + 
  geom_density()+
  facet_grid(df_coded$code_topic ~ df_coded$TASK) +
  scale_fill_brewer(type="qual", palette = 3) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Topic of Utterance over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
    fill = "Topic"
  ) + theme_minimal() + theme(legend.position = "blank")



#DOTPLOT
(p <- ggplot(df_coded, aes(x=relative_time, y = PNUM, color=fct_rev(code_topic))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_coded$TASK) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Topic of Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Task",
    color = "Topic"
  )) 

#DOTPLOT
ggplot(df_coded, aes(x=relative_time, y = fct_rev(TASK), color=fct_rev(code_topic))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_coded$PNUM) +
  # facet_grid(df_coded$TASK ~ df_coded$DATASET) +
  scale_color_brewer(type="qual", palette = 3) +
  theme_minimal() + labs(
    title = "Topic of Utterances over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
) 



ggsave(p, file="figures/topics_in_time.png")


```

## [DETAIL of] Utterances

NEXT we explore the distribution of specific detail utterances across Analysis Task, Dataset, Participant and Time.

***RQ: What specific things did participants talk aloud during EDA? Are there any details folks only*** **mention during static(v)interactive, or nominal(v)numeric tasks? Any substantial changes in proportion by TASK or DATASET?**

***Answer:***

### DETAIL---PROCESS

```{r, message=FALSE}

#PREP DATA FRAMES
df_process <- df_coded %>% 
  filter(code_topic=="PROCESS") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_process <- df_coded %>% 
  filter(code_topic=="PROCESS") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_process %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_process %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = "PuRd") +
  labs( title = "PROCESS Utterances by TASK",
        subtitle = "",
        caption = "weak to moderate difference in PROCESS utterances by TASK, \n but these do not seem substantial when broken into the two categories",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = "PuRd") +
  labs( title = "PROCESS Utterances by DATASET",
        subtitle = "",
        caption = "much more substantial differences in PROCESS utterances by DATASET, \n consistent with intution Ps had more to say about the numeric (vs) nominal outcome variable",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_process, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_process$TASK) +
  scale_color_brewer(type="seq", palette = "PuRd") +
  theme_minimal() + labs(
    title = "PROCESS Utterances by timecourse of Task",
    caption = "appear randomly distributed through time \n expected and reasonable given PROCESS utterances are meta-level",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_process, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_process$TASK ~ df_time_process$code_detail ) +
  scale_fill_brewer(type="seq", palette = "PuRd") +
  theme_minimal() + labs(
    title = "PROCESS Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")


#PROCESSES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df_process) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="seq", palette = "PuRd") +
  labs(
    title = "PROCESS Utterances by Participant and Task",
    subtitle = "",
    caption = "TODO explore P13 representation comments",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()
)

ggsave(p, file="figures/process_counts.png")


```
#### PROCESS-REPS-HIGH

PROOF OF CONCEPT FOR reporting REPRESENTATIONS (high level type) LINKED TO UTTERANCES
```{r}

#FILTER JOINED DATAFRAME
df <- df_joined %>% filter(code_topic =="PROCESS")

#AGGREGATE PROCESS X REP TYPE
gf_bar( ~ rep_type, fill = ~code_detail , data = df) %>% 
  gf_facet_grid(TASK~code_detail) + 
  scale_fill_brewer(type="seq", palette = "PuRd") + 
  labs(title = "PROCESS Utterances & Representations ",
    subtitle = "",
    caption = "",
    x = "REPN",
    y = "number of coded utterances",
    fill = "TOPIC")+
  theme_minimal()

#PARTICIPANT PROCESS X REP 
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df) %>% 
  gf_facet_grid(rep_type~TASK) + 
  scale_fill_brewer(type="seq", palette = "PuRd") +
  labs(
    title = "PROCESS Utterances & Representations ",
    subtitle = "",
    caption = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()
)


```



#### PROCESS-REPS-LOW STUCK HERE

WHOAH nelly how to [heatmap??] a contingency table? Most likely need to reduce REP list by removing zero cells and just focus on what reps WERE used
```{r results="asis"}

#FILTER JOINED DATAFRAME
# df <- df_joined %>% filter(code_topic =="PROCESS")
# 
# c <- table(  df$REP, df$code_detail)
# d <- as.data.frame.matrix(c)
# 
# plot(d)



#HERE
vcd::mosaic(formula = ~REP + code_detail,
       data = df,
       main = "Proportion of Utterances by TASK and DATASET",
       sub = "u = 734 utterance-codes",
       # labeling = labeling_values,
       labeling_args = list(set_varnames = c(graph = "TASK",
                            datset = "DATASET")))



# #AGGREGATE PROCESS X REP TYPE
# gf_bar( ~ rep_type, fill = ~code_detail , data = df) %>%
#   gf_facet_grid(TASK~code_detail) +
#   scale_fill_brewer(type="seq", palette = "PuRd") +
#   labs(title = "PROCESS Utterances & Representations ",
#     subtitle = "",
#     caption = "",
#     x = "REPN",
#     y = "number of coded utterances",
#     fill = "TOPIC")+
#   theme_minimal()
#
# #PARTICIPANT PROCESS X REP
# (p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df) %>%
#   gf_facet_grid(rep_type~TASK) +
#   scale_fill_brewer(type="seq", palette = "PuRd") +
#   labs(
#     title = "PROCESS Utterances & Representations ",
#     subtitle = "",
#     caption = "",
#     x = "number of coded utterances",
#     y = "participant",
#     fill = "TOPIC"
#   ) + theme_minimal()
# )


```





### DETAIL---DATASET

```{r, message=FALSE}

#PREP DATA FRAMES
df_dataset <- df_coded %>% 
  filter(code_topic=="DATASET") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_dataset <- df_coded %>% 
  filter(code_topic=="DATASET") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_dataset %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_dataset %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 4) +
  labs( title = "DATASET Utterances by TASK",
        subtitle = "",
        caption = "notable decrease MISSING DATA utterances in IXN \n unsure what might explain this, explore at individual level",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 4) +
  labs( title = "DATASET Utterances by DATASET",
        subtitle = "",
        caption = "minor differences by DATASET  reasonable given DATASET \n  represenations are typically tabluar (data dictionary, describe, head/tail)",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_dataset, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_dataset$TASK) +
  scale_color_brewer(type="seq", palette = 4) +
  theme_minimal() + labs(
    title = "DATASET Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    caption = "notable sparsity in center of timecourse, reasonable as EDA normative behavior \n is to consider dataframe shape and missing data at the start of an analysis",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_dataset, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_dataset$TASK ~ df_time_dataset$code_detail ) +
  scale_fill_brewer(type="seq", palette = 4) +
  theme_minimal() + labs(
    title = "DATASET Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances",
        caption = "sensical that the most uniformly distributed detail code is missing data \n as this can be discovered via graphing",
  ) + theme_minimal() + theme(legend.position = "blank")


#DATASET UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df_dataset) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="seq", palette = 4) +
  labs(
    title = "DATASET Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC",
    caption = "P11, P12 contribute to MISSING DATA \n P9 contributes largely to variable metadata \n INVESTIGATE FURTHER",
  ) + theme_minimal()
)

ggsave(p, file="figures/dataset_counts.png")



```

### DETAIL---VARIABLE

```{r, message=FALSE}

#PREP DATA FRAMES
df_variable <- df_coded %>% 
  filter(code_topic=="VARIABLE") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_variable <- df_coded %>% 
  filter(code_topic=="VARIABLE") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_variable %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_dataset <- df_variable %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 5) +
  labs( title = "VARIABLE Utterances by TASK",
        subtitle = "",
        caption = "notably more RANGE obs in STATIC than INTERACTIVE \n TODO consider collapsing distribution-variance ",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_dataset, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 5) +
  labs( title = "VARIABLE Utterances by DATASET",
        caption = "Notably more SHAPE in SPACE than HAPPINESS \n notably fewer RANGE in SPACE than HAPPINESS \n TODO are shape and range normalized across variable types? ",
        subtitle = "",
        x= "DATASET", y = "count") + theme_minimal() 


#DETAILS DOTPLOT
ggplot(df_time_variable, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_variable$TASK) +
  scale_color_brewer(type="seq", palette = 5) +
  theme_minimal() + labs(
    title = "VARIABLE Utterances by timecourse of Task",
    caption = "IXN appears more BIMODAL than STATIC where the distribution is more uniform",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_variable, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_variable$TASK ~ df_time_variable$code_detail ) +
  scale_fill_brewer(type="seq", palette = 5) +
  theme_minimal() + labs(
    title = "VARIABLE Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")


#VARIABLE UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df_variable) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="seq", palette = 5) +
  labs(
    title = "VARIABLE Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC",
    caption = "substantial individual differences, most everyone made some comments \n at some point about distribution shape, but \n discussion of outliers, variance and range was more idiosyncratic \n TODO INVESTIGATE P4 STATIC RANGE very high",
  ) + theme_minimal()
)

ggsave(p, file="figures/variable_counts.png")


```

### DETAIL---RELATIONSHIP

```{r, message=FALSE}

#PREP DATA FRAMES
df_relationship <- df_coded %>% 
  filter(code_topic=="RELATIONSHIP") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,code_detail)

df_time_relationship <- df_coded %>% 
  filter(code_topic=="RELATIONSHIP") %>% 
  dplyr::select(pid,PNUM,TASK,DATASET,relative_time,code_detail)

df_summary_task <- df_relationship %>% 
  group_by(code_detail, TASK) %>% 
  dplyr::summarise(c = n())

df_summary_relationship <- df_relationship %>% 
  group_by(code_detail, DATASET) %>% 
  dplyr::summarise(c = n())


#DETAILS BY TASK
ggplot(df_summary_task, aes(x = TASK, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 3) +
  labs( title = "RELATIONSHIP Utterances by TASK",
        subtitle = "",
        caption = "TODO think about proportion of existence and strength/direction",
        x= "TASK", y = "count") + theme_minimal() 

#DETAILS BY DATASET
ggplot(df_summary_relationship, aes(x = DATASET, y=c, fill= code_detail)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="seq", palette = 3) +
  labs( title = "RELATIONSHIP Utterances by DATASET",
        subtitle = "",
        caption = "substantial differences by DATASET, \n consistent with pattern of results with VARIABLE utterances \n perhaps due to sparsity of knowledge of analysis of nominal X nominal relationships, and tool coverage",
        x= "DATASET", y = "count") + theme_minimal() 


##CONSIDER THIS
gf_bar( ~code_detail, fill = ~code_detail, data = df_relationship) %>% 
  gf_facet_grid(TASK ~ DATASET) + labs(
    title="LOOK at this more closely for data validation on relationship utts",
    caption = "TODO CONSIDER THIS",
  )

#DETAILS DOTPLOT
ggplot(df_time_relationship, aes(x=relative_time, y = PNUM, color=fct_rev(code_detail))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_time_relationship$TASK) +
  scale_color_brewer(type="seq", palette = 3) +
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterances by timecourse of Task",
    caption = "uniformly distributed, as expected \n may see variance if dimension of HYPOTHESIS vs OBSERVATION was coded",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
  ) 

#DETAIL HISTOGRAMS BY TASK
ggplot(df_time_relationship, aes(x = relative_time, fill = fct_rev(code_detail))) + 
  geom_histogram(binwidth = 30) + 
  facet_grid(df_time_relationship$TASK ~ df_time_relationship$code_detail ) +
  scale_fill_brewer(type="seq", palette = 3) +
  theme_minimal() + labs(
    title = "RELATIONSHIP Utterances by timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterances"
  ) + theme_minimal() + theme(legend.position = "blank")


#RELATIONSHIP UTTERANCES by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(code_detail), data = df_relationship) %>% 
  gf_facet_grid(.~TASK) + 
  scale_fill_brewer(type="seq", palette = 3) +
  labs(
    title = "RELATIONSHIP Utterances by Participant and Task",
    subtitle = "",
    x = "number of coded utterances",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal()
)

ggsave(p, file="figures/relationship_counts.png")

```




# REPRESENTATIONS

**Representations** are computationally-generated visual-spatial artifacts that participants use during the EDA tasks. These include data visualizations, but also tabular code outputs, or other data structures returned by Python code.  

In the following subsections we start by exploring the distribution of *kinds of representations* participants generated based on TASK, DATASET, and PARTICIPANT. We then explore a _subset_ of representations that are associated with _utterances_ (i.e. not every representation is commented on). And finally we dig further into the utterances that are associated with _realtime interaction_  with an interactive visualization (i.e. not every representation generated during the IXN task is interactive, and not every interactive visualization generated is acted upon by the participant). 

## WIP [All] Representations


***RQ: How many representations did participants generate? Of what kinds? At what times during the process of analysis?***
(These are the representations coming from telemetry. Not connected to utterances explicitly.  Code only reps are excluded, but tabular output of code cells (eg. .info(), .describe(), etc. included)


### NUMBER of REPRESENTATIONS

```{r}
#COUNT BY TASK AND DATASET
ctable(x = df_telemetry$TASK, 
       y = df_telemetry$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>% 
  group_by(TASK,DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK AND DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "(Telemetry) Representations by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")
```

### ADDING INTERACTIONS
```{r}
#ADDED INTERACTION
df <- df_telemetry %>% filter(rep_type=="VIS")
gf_bar(~ IXN, fill = ~IXN,data = df %>% filter(TASK=="ixn")) %>% 
  gf_facet_grid(DATASET~REP) + 
  scale_fill_brewer(type="qual", palette = 2, direction = -1) +
  theme_minimal() + labs(
    title = "Where do participants add Interaction?",
    subtitle="(during the Interactive Task) which visualizations are made interactive?",
    caption = "TODO INVESTIGATE where is profiler seems really low \n added ixn here means they added an ixn technique",
    fill = "added ixn"
  )

```

### TODO IXN TECHNIQUES
```{r} 
freq(df_telemetry$technique)
```

### TYPES by TASK

```{r results='asis'}

#TYPES by TASK
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$TASK, 
       prop = "t")   # Show row proportions


#REPS by TASK
ctable(x = df_telemetry$REP, 
       y = df_telemetry$TASK, 
       prop = "t")   # Show row proportions
```


### TYPES by DATASET

```{r results='asis'}

#TYPES by DATASET
ctable(x = df_telemetry$rep_type, 
       y = df_telemetry$DATASET, 
       prop = "t")   


#REPS by DATASET
ctable(x = df_telemetry$REP, 
       y = df_telemetry$DATASET, 
       prop = "t")   
```
### by TASK and DATASET -- TYPE 

```{r}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>%
  group_by(rep_type, TASK,DATASET) %>%
  dplyr::summarise( .groups = "keep",
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(rep_type))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "REPRESENTATIONS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="REP-TYPE") + theme_minimal()

```


### EXAMINE THIS! by TASK and DATASET -- DETAIL 

```{r}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_telemetry %>%
  group_by(REP, TASK,DATASET) %>%
  dplyr::summarise( .groups = "keep",
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= DATASET)) +
  facet_wrap(df_summary$REP) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "REPRESENTATIONS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="DATASET") + 
  scale_fill_brewer(type="qual", palette = 1) + theme_minimal()

```


### by PARTICIPANT — TOTAL

```{r results="asis", message=FALSE}

#REPS by PARTICPANT facet TASK
gf_bar( PNUM ~., fill = ~ DATASET, data = df_telemetry) %>% 
  gf_facet_grid(.~TASK) + 
  labs(
    title = "Telemetry Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of REPRESENTATIONS",
    y = "participant",
    fill = "DATASET"
  ) + scale_fill_brewer(type="qual", palette = 1) + theme_minimal()

```

### by PARTICIPANT — TYPE

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT AND TASK
ctable(x = df_telemetry$PNUM, 
       y = df_telemetry$rep_type, 
       prop = "r")  

#REPS by PARTICPANT facet TASK
gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_telemetry) %>% 
  gf_facet_grid(DATASET~TASK) + 
  labs(
    title = "Telemetry Representations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of REPRESENTATIONS",
    y = "participant",
    fill = "REP-TYPE"
  ) + scale_fill_brewer(type="qual", palette = 4) + theme_minimal()

```


### TODO timestamps on telemetry needs cleaning 

```{r}

# #DOTPLOT
# ggplot(df_coded, aes(x=relative_time, y = PNUM)) + 
#   geom_point(alpha=0.5, size=3) +
#   facet_grid(df_coded$TASK) +
#   scale_color_brewer(type="qual", palette = 3) +
#   theme_minimal() + labs(
#     title = "Participant Utterances over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "Participant",
#     color = "Topic"
#   ) 
# 
# 
# #HISTOGRAMS BY TASK
# ggplot(df_coded, aes(x = relative_time)) + 
#   geom_histogram(binwidth = 30,aes(y=..density..)) + 
#   geom_density()+
#   facet_grid(df_coded$TASK) +
#   theme_minimal() + labs(
#     title = "Participant Utterances over timecourse of Task",
#     x= "timecourse of task (seconds)", y = "frequency of utterances",
#   ) + theme_minimal() + theme(legend.position = "blank")


```



## [Utterance] Representations

THIS SECTION covers representations EXPLICITLY LINKED to UTTERANCES.  Does not include ALL representations generated, but rather, what representations were being used when the participant generated utterances. 

### by TASK OR DATASET

```{r results='asis', message=FALSE}

#COUNT BY TASK
ctable(x = df_joined$rep_type, 
       y = df_joined$TASK, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_joined %>% 
  group_by(rep_type, TASK) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(rep_type))) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "UTTERANCE-REPS by TASK",
        subtitle = "",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal() 
# + theme(legend.position = "blank")

#COUNT BY DATASET
ctable(x = df_joined$rep_type, 
       y = df_joined$DATASET, 
       prop = "t")  

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_joined %>% 
  group_by(rep_type, DATASET) %>% 
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY DATASET
ggplot(df_summary, aes(x = DATASET, y=c, fill= fct_rev(rep_type))) + 
  geom_col() + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "UTTERANCE-REPS by DATASET",
        subtitle = "",
        x= "DATASET", y = "count", fill="TOPIC") + theme_minimal() 
# + theme(legend.position = "blank")
```


### by TASK and DATASET

```{r results="asis", message=FALSE}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_joined %>%
  group_by(rep_type, TASK,DATASET) %>%
  dplyr::summarise(
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = TASK, y=c, fill= fct_rev(rep_type))) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "UTTERANCE-REPS by TASK and DATASET",
        subtitle = "",
        x= "TASK", y = "count", fill="TOPIC") + theme_minimal()
# + theme(legend.position = "blank")

```


### by PARTICIPANT

```{r results="asis", message=FALSE}

#COUNT BY PARTICIPANT 
ctable(x = df_joined$PNUM, 
       y = df_joined$rep_type, 
       prop = "r")  

#TOPICS by PARTICPANT facet TASK
(p <- gf_bar( PNUM ~., fill = ~ fct_rev(rep_type), data = df_joined) %>% 
  gf_facet_grid(DATASET~TASK) + 
  scale_fill_brewer(type="qual", palette = 4) +
  labs(
    title = "Utterance-Represenations by Participant, Dataset and Task",
    subtitle = "",
    x = "number of representations",
    y = "participant",
    fill = "TOPIC"
  ) + theme_minimal())

ggsave(p, file="figures/utterance_reptypes_by_count.png")

```

### by TIME

```{r}

#HISTOGRAMS BY TASK
ggplot(df_joined, aes(x = relative_time)) + 
  geom_histogram(binwidth = 30,aes(y=..density.., fill = fct_rev(rep_type), color = fct_rev(rep_type))) + 
  geom_density()+
  facet_grid(df_joined$rep_type ~ df_joined$TASK) +
  scale_fill_brewer(type="qual", palette = 4) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "UTTERANCE-REPS over timecourse of Task",
    x= "timecourse of task (seconds)", y = "frequency of utterance-reps",
    fill = "Topic"
  ) + theme_minimal() + theme(legend.position = "blank")



#DOTPLOT
(p <- ggplot(df_joined, aes(x=relative_time, y = PNUM, color=fct_rev(rep_type))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_joined$TASK) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "Utterance-Reps over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Task",
    color = "Topic"
  )) 

#DOTPLOT
ggplot(df_joined, aes(x=relative_time, y = fct_rev(TASK), color=fct_rev(rep_type))) + 
  geom_point(alpha=0.5, size=3) +
  facet_grid(df_joined$PNUM) +
  # facet_grid(df_joined$TASK ~ df_joined$DATASET) +
  scale_color_brewer(type="qual", palette = 4) +
  theme_minimal() + labs(
    title = "Utterance-Reps over timecourse of Task",
    x= "timecourse of task (seconds)", y = "Participant",
    color = "Topic"
) 



ggsave(p, file="figures/utterance_reptypes_in_time.png")


```


## [Enacted] Representations [TODO PRIORITY]

THIS SECTION would include the (very) small number of UTTERANCE-REPS that are flagged as occuring when interaction was ACTIVELY BEING USED SHOULD be a quick but effective. 

```{r}

#DF SUMMARIZED BY TASK + DATASET
df_summary <- df_joined %>%
  filter(TASK == "ixn") %>%  #can only occur during interactive task
  group_by(DATASET,code_topic,ixn) %>% 
  dplyr::summarise( .groups="keep",
    c = n()
  )

##no need to summarize by rep_type because only vis can be ixn
## consider middle level summary of uni vs bi vs multivariate vis 


#STACKED BAR BY TASK
ggplot(df_summary, aes(x = DATASET, y=c, fill= ixn)) + 
  geom_col() + 
  facet_wrap(df_summary$code_topic) + 
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") + 
  # scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "KINDS of utterances made WHILE INTERACTING with ixn visualization",
        subtitle = "TODO ZOOM IN ON THIS",
        x= "DATASET", y = "count") + theme_minimal() 
# + theme(legend.position = "blank")


```


```{r}


df <- df_joined %>% dplyr::select(PNUM, TASK, DATASET, code_topic, code_detail, REP, rep_type, relative_time, ixn) %>% filter(TASK=="ixn")


gf_bar( ~REP , fill = ~ixn, data = df) %>% 
  gf_facet_grid(ixn ~ DATASET) + theme_minimal() + 
  labs( title = "Utterances WHILE INTERACTING with IXN representations")


df_summary <- df_joined %>% 
  filter(TASK == "ixn") %>%  #can only occur during interactive task
  group_by(DATASET,REP,ixn) %>% 
  summarise( .groups = "keep",
    c = n()
  )

#STACKED BAR BY TASK FACET DATASET
ggplot(df_summary, aes(x = REP, y=c, fill= ixn)) +
  facet_wrap(df_summary$DATASET) +
  geom_col() +
  geom_text(aes(label=c), size = 3, hjust = 0.5, vjust = 1.5, position = "stack") +
  scale_fill_brewer(type="qual", palette = 4) +
  labs( title = "Utterances WHILE INTERACTING with IXN representations",
        subtitle = "",
        x= "", y = "count", fill="interacting?") + theme_minimal()
# + theme(legend.position = "blank")
```

# MODELLING

```{r VIZ-B4-MODEL, message=FALSE}

#DEFINE DATAFRAME
df <- df_coded %>% select(pid, uid, TASK, DATASET) 
  
# #MOSAIC PLOT
# mosaic(formula = ~DATASET + TASK, 
#        data = df,
#        main = "Proportion of Utterances by TASK and DATASET", 
#        sub = "u = 734 utterance-codes",
#        labeling = labeling_values,
#        labeling_args = list(set_varnames = c(graph = "TASK",
#                             datset = "DATASET")))




```

## Predicting NUMBER of UTTERANCES

*How much variance in number of utterances is explained DATASET, TASK and PARTICIPANT?*

### OLS Mixed Effects Model

```{r OLS-MIXED-EFFECTS-MODELS}

#DEFINE DATAFRAME
df <- df_coded %>% group_by(pid, DATASET, TASK) %>% 
  dplyr::summarise( .groups = "keep",
    n_utterances = n()
  )

#NUMBER UTTERANCES predicted by DATASET + TASK | participatnt--> MIXED LINEAR REGRESSION
print("LMER, UTTERANCES ~ DATASET + TASK")
mm1 <- lmer(n_utterances ~ DATASET + TASK+ (1|pid), data = df)
paste("Model")
summ(mm1)
paste("Partition Variance")
anova(mm1)
paste("Confidence Interval on Parameter Estimates")
confint(mm1)
report(mm1) #sanity check
plot_model(mm1,  show.intercept = TRUE)
check_model(mm1)


#NUMBER UTTERANCES predicted by DATASET * TASK  | participatnt--> MIXED LINEAR REGRESSION
print("LMER, UTTERANCES ~ DATASET X TASK")
mm2 <- lmer(n_utterances ~ DATASET * TASK + (1|pid), data = df)
paste("Model")
summ(mm2)
paste("Partition Variance")
anova(mm2)
paste("Confidence Interval on Parameter Estimates")
confint(mm2)
report(mm2) #sanity check
plot_model(mm2,  show.intercept = TRUE)
check_model(mm2)
```



```{r POISSON-MIXED-EFFECTS-MODELS}
### POISSON Mixed Effects Models
### ARF poisson is recommended over OLS regression for count data 
### BUT they are challenging to interpret (log odds) and the estimates need to be translated (logodds?)
### NOT innapropriate to use OLS instead
# 
# #NUMBER UTTERANCES predicted by TASK + DATASET  | participatnt--> POISSON MIXED LINEAR REGRESSION
# print("POISSON-MER, UTTERANCES ~ DATASET + TASK")
# pmm1 <- glmer(n_utterances ~ TASK + DATASET + (1|pid), data = df, family = "poisson")
# paste("Model")
# summ(pmm1)
# paste("Partition Variance")
# anova(pmm1)
# paste("Confidence Interval on Parameter Estimates")
# confint(pmm1)
# report(pmm1) #sanity check
# plot_model(pmm1,  show.intercept = TRUE)
# check_model(pmm1)
# 
# #NUMBER UTTERANCES predicted by TASK X DATASET  | participatnt--> POISSON MIXED LINEAR REGRESSION
# print("POISSON-MER, UTTERANCES ~ DATASET X TASK")
# pmm2 <- glmer(n_utterances ~ TASK * DATASET + (1|pid), data = df, family = "poisson")
# paste("Model")
# summ(pmm2)
# paste("Partition Variance")
# anova(pmm2)
# paste("Confidence Interval on Parameter Estimates")
# confint(pmm2)
# report(pmm2) #sanity check
# plot_model(pmm2,  show.intercept = TRUE)
# check_model(pmm2)

```
